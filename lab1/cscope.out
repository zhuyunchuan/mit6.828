cscope 15 $HOME/mit6.828/myjos/lab1 -q 0000000912 0000068763
	@boot/main.c

1 
	~<öc/x86.h
>

2 
	~<öc/ñf.h
>

32 
	#SECTSIZE
 512

	)

33 
	#ELFHDR
 ((
Elf
 *) 0x10000)

34 

	)

35 
ªad£˘
(*, 
uöt32_t
);

36 
ªad£g
(
uöt32_t
, uint32_t, uint32_t);

38 
	$boŸmaö
()

40 
Proghdr
 *
ph
, *
ïh
;

44 
	`ªad£g
((
uöt32_t
Ë
ELFHDR
, 
SECTSIZE
*8, 0);

47 i‡(
ELFHDR
->
e_magic
 !
ELF_MAGIC
)

48 
bad
;

51 
ph
 = (
Proghdr
 *Ë((
uöt8_t
 *Ë
ELFHDR
 + ELFHDR->
e_phoff
);

52 
ïh
 = 
ph
 + 
ELFHDR
->
e_phnum
;

53 ; 
ph
 < 
ïh
;Öh++)

54 
	`ªad£g
(
ph
->
p_va
,Öh->
p_memsz
,Öh->
p_off£t
);

59 (((*)()Ë(
ELFHDR
->
e_íåy
 & 0xFFFFFF))();

61 
bad
:

62 
	`outw
(0x8A00, 0x8A00);

63 
	`outw
(0x8A00, 0x8E00);

66 
	}
}

71 
	$ªad£g
(
uöt32_t
 
va
, uöt32_à
cou¡
, uöt32_à
off£t
)

73 
uöt32_t
 
íd_va
;

75 
va
 &= 0xFFFFFF;

76 
íd_va
 = 
va
 + 
cou¡
;

79 
va
 &~(
SECTSIZE
 - 1);

82 
off£t
 = (off£à/ 
SECTSIZE
) + 1;

87 
va
 < 
íd_va
) {

88 
	`ªad£˘
((
uöt8_t
*Ë
va
, 
off£t
);

89 
va
 +
SECTSIZE
;

90 
off£t
++;

92 
	}
}

94 
	$waôdisk
()

97 (
	`öb
(0x1F7) & 0xC0) != 0x40)

99 
	}
}

101 
	$ªad£˘
(*
d°
, 
uöt32_t
 
off£t
)

104 
	`waôdisk
();

106 
	`outb
(0x1F2, 1);

107 
	`outb
(0x1F3, 
off£t
);

108 
	`outb
(0x1F4, 
off£t
 >> 8);

109 
	`outb
(0x1F5, 
off£t
 >> 16);

110 
	`outb
(0x1F6, (
off£t
 >> 24) | 0xE0);

111 
	`outb
(0x1F7, 0x20);

114 
	`waôdisk
();

117 
	`ö¶
(0x1F0, 
d°
, 
SECTSIZE
/4);

118 
	}
}

	@inc/assert.h

3 #i‚de‡
JOS_INC_ASSERT_H


4 
	#JOS_INC_ASSERT_H


	)

6 
	~<öc/°dio.h
>

8 
_w¨n
(const *, , const *, ...);

9 
	$_∑nic
(c⁄° *, , c⁄° *, ...Ë
	`__©åibuã__
((
n‹ëu∫
));

11 
	#w¨n
(...Ë
	`_w¨n
(
__FILE__
, 
__LINE__
, 
__VA_ARGS__
)

	)

12 
	#∑nic
(...Ë
	`_∑nic
(
__FILE__
, 
__LINE__
, 
__VA_ARGS__
)

	)

14 
	#as£π
(
x
) \

15 dÿ{ i‡(!(
x
)Ë
	`∑nic
("as£πi⁄ faûed: %s", #x); 
	}
} 0)

	)

18 
	#°©ic_as£π
(
x
ËxË0: (x):

	)

	@inc/elf.h

1 #i‚de‡
JOS_INC_ELF_H


2 
	#JOS_INC_ELF_H


	)

4 
	#ELF_MAGIC
 0x464C457FU

	)

6 
	sElf
 {

7 
uöt32_t
 
	me_magic
;

8 
uöt8_t
 
	me_ñf
[12];

9 
uöt16_t
 
	me_ty≥
;

10 
uöt16_t
 
	me_machöe
;

11 
uöt32_t
 
	me_vîsi⁄
;

12 
uöt32_t
 
	me_íåy
;

13 
uöt32_t
 
	me_phoff
;

14 
uöt32_t
 
	me_shoff
;

15 
uöt32_t
 
	me_Êags
;

16 
uöt16_t
 
	me_ehsize
;

17 
uöt16_t
 
	me_phítsize
;

18 
uöt16_t
 
	me_phnum
;

19 
uöt16_t
 
	me_shítsize
;

20 
uöt16_t
 
	me_shnum
;

21 
uöt16_t
 
	me_sh°∫dx
;

24 
	sProghdr
 {

25 
uöt32_t
 
	mp_ty≥
;

26 
uöt32_t
 
	mp_off£t
;

27 
uöt32_t
 
	mp_va
;

28 
uöt32_t
 
	mp_∑
;

29 
uöt32_t
 
	mp_fûesz
;

30 
uöt32_t
 
	mp_memsz
;

31 
uöt32_t
 
	mp_Êags
;

32 
uöt32_t
 
	mp_Æign
;

35 
	sSe˘hdr
 {

36 
uöt32_t
 
	msh_«me
;

37 
uöt32_t
 
	msh_ty≥
;

38 
uöt32_t
 
	msh_Êags
;

39 
uöt32_t
 
	msh_addr
;

40 
uöt32_t
 
	msh_off£t
;

41 
uöt32_t
 
	msh_size
;

42 
uöt32_t
 
	msh_lök
;

43 
uöt32_t
 
	msh_öfo
;

44 
uöt32_t
 
	msh_addølign
;

45 
uöt32_t
 
	msh_ítsize
;

49 
	#ELF_PROG_LOAD
 1

	)

52 
	#ELF_PROG_FLAG_EXEC
 1

	)

53 
	#ELF_PROG_FLAG_WRITE
 2

	)

54 
	#ELF_PROG_FLAG_READ
 4

	)

57 
	#ELF_SHT_NULL
 0

	)

58 
	#ELF_SHT_PROGBITS
 1

	)

59 
	#ELF_SHT_SYMTAB
 2

	)

60 
	#ELF_SHT_STRTAB
 3

	)

63 
	#ELF_SHN_UNDEF
 0

	)

	@inc/error.h

3 #i‚de‡
JOS_INC_ERROR_H


4 
	#JOS_INC_ERROR_H


	)

7 
	#E_UNSPECIFIED
 1

8 
	#E_BAD_ENV
 2

10 
	#E_INVAL
 3

11 
	#E_NO_MEM
 4

12 
	#E_NO_FREE_ENV
 5

14 
	#E_FAULT
 6

15 

	)

16 
	#MAXERROR
 6

	)

	@inc/kbdreg.h

1 #i‚de‡
JOS_KBDREG_H


2 
	#JOS_KBDREG_H


	)

5 
	#KEY_HOME
 0xE0

	)

6 
	#KEY_END
 0xE1

	)

7 
	#KEY_UP
 0xE2

	)

8 
	#KEY_DN
 0xE3

	)

9 
	#KEY_LF
 0xE4

	)

10 
	#KEY_RT
 0xE5

	)

11 
	#KEY_PGUP
 0xE6

	)

12 
	#KEY_PGDN
 0xE7

	)

13 
	#KEY_INS
 0xE8

	)

14 
	#KEY_DEL
 0xE9

	)

19 
	#KBSTATP
 0x64

	)

20 
	#KBS_DIB
 0x01

	)

21 
	#KBS_IBF
 0x02

	)

22 
	#KBS_WARM
 0x04

	)

23 
	#KBS_OCMD
 0x08

	)

24 
	#KBS_NOSEC
 0x10

	)

25 
	#KBS_TERR
 0x20

	)

26 
	#KBS_RERR
 0x40

	)

27 
	#KBS_PERR
 0x80

	)

29 
	#KBCMDP
 0x64

	)

30 
	#KBC_RAMREAD
 0x20

	)

31 
	#KBC_RAMWRITE
 0x60

	)

32 
	#KBC_AUXDISABLE
 0xa7

	)

33 
	#KBC_AUXENABLE
 0xa8

	)

34 
	#KBC_AUXTEST
 0xa9

	)

35 
	#KBC_KBDECHO
 0xd2

	)

36 
	#KBC_AUXECHO
 0xd3

	)

37 
	#KBC_AUXWRITE
 0xd4

	)

38 
	#KBC_SELFTEST
 0xØ

	)

39 
	#KBC_KBDTEST
 0xab

	)

40 
	#KBC_KBDDISABLE
 0xad

	)

41 
	#KBC_KBDENABLE
 0x´

	)

42 
	#KBC_PULSE0
 0x„

	)

43 
	#KBC_PULSE1
 0xfd

	)

44 
	#KBC_PULSE2
 0xfb

	)

45 
	#KBC_PULSE3
 0xf7

	)

47 
	#KBDATAP
 0x60

	)

48 
	#KBOUTP
 0x60

	)

50 
	#K_RDCMDBYTE
 0x20

	)

51 
	#K_LDCMDBYTE
 0x60

	)

53 
	#KC8_TRANS
 0x40

	)

54 
	#KC8_MDISABLE
 0x20

	)

55 
	#KC8_KDISABLE
 0x10

	)

56 
	#KC8_IGNSEC
 0x08

	)

57 
	#KC8_CPU
 0x04

	)

58 
	#KC8_MENABLE
 0x02

	)

59 
	#KC8_KENABLE
 0x01

	)

60 
	#CMDBYTE
 (
KC8_TRANS
|
KC8_CPU
|
KC8_MENABLE
|
KC8_KENABLE
)

	)

63 
	#KBC_RESET
 0xFF

	)

64 
	#KBC_RESEND
 0xFE

	)

65 
	#KBC_SETDEFAULT
 0xF6

	)

66 
	#KBC_DISABLE
 0xF5

	)

67 
	#KBC_ENABLE
 0xF4

	)

68 
	#KBC_TYPEMATIC
 0xF3

	)

69 
	#KBC_SETTABLE
 0xF0

	)

70 
	#KBC_MODEIND
 0xED

	)

71 
	#KBC_ECHO
 0xEE

	)

74 
	#KBR_EXTENDED
 0xE0

	)

75 
	#KBR_RESEND
 0xFE

	)

76 
	#KBR_ACK
 0xFA

	)

77 
	#KBR_OVERRUN
 0x00

	)

78 
	#KBR_FAILURE
 0xFD

	)

79 
	#KBR_BREAK
 0xF0

	)

80 
	#KBR_RSTDONE
 0xAA

	)

81 
	#KBR_ECHO
 0xEE

	)

	@inc/malloc.h

1 #i‚de‡
JOS_INC_MALLOC_H


2 
	#JOS_INC_MALLOC_H
 1

	)

4 *
mÆloc
(
size_t
 
size
);

5 
‰ì
(*
addr
);

	@inc/memlayout.h

1 #i‚de‡
JOS_INC_MEMLAYOUT_H


2 
	#JOS_INC_MEMLAYOUT_H


	)

4 #i‚de‡
__ASSEMBLER__


5 
	~<öc/ty≥s.h
>

6 
	~<öc/queue.h
>

7 
	~<öc/mmu.h
>

16 
	#GD_KT
 0x08

17 
	#GD_KD
 0x10

18 
	#GD_UT
 0x18

19 
	#GD_UD
 0x20

20 
	#GD_TSS
 0x28

21 

	)

82 
	#KERNBASE
 0xF0000000

	)

87 
	#IOPHYSMEM
 0x0A0000

	)

88 
	#EXTPHYSMEM
 0x100000

	)

94 
	#VPT
 (
KERNBASE
 - 
PTSIZE
)

	)

95 
	#KSTACKTOP
 
VPT


	)

96 
	#KSTKSIZE
 (8*
PGSIZE
)

97 
	#ULIM
 (
KSTACKTOP
 - 
PTSIZE
)

	)

105 
	#UVPT
 (
ULIM
 - 
PTSIZE
)

	)

107 
	#UPAGES
 (
UVPT
 - 
PTSIZE
)

	)

109 
	#UENVS
 (
UPAGES
 - 
PTSIZE
)

	)

116 
	#UTOP
 
UENVS


	)

118 
	#UXSTACKTOP
 
UTOP


	)

121 
	#USTACKTOP
 (
UTOP
 - 2*
PGSIZE
)

	)

124 
	#UTEXT
 (2*
PTSIZE
)

	)

127 
	#UTEMP
 ((*Ë
PTSIZE
)

	)

130 
	#PFTEMP
 (
UTEMP
 + 
PTSIZE
 - 
PGSIZE
)

	)

132 
	#USTABDATA
 (
PTSIZE
 / 2)

	)

135 #i‚de‡
__ASSEMBLER__


151 
uöt32_t
 
	t±e_t
;

152 
uöt32_t
 
	tpde_t
;

154 vﬁ©ûê
±e_t
 
v±
[];

155 vﬁ©ûê
pde_t
 
vpd
[];

166 
LIST_HEAD
(
Page_li°
, 
Page
);

167 
	$LIST_ENTRY
(
	tPage
Ë
	tPage_LIST_íåy_t
;

169 
	sPage
 {

170 
Page_LIST_íåy_t
 
µ_lök
;

177 
uöt16_t
 
µ_ªf
;

	@inc/mmu.h

1 #i‚de‡
JOS_INC_MMU_H


2 
	#JOS_INC_MMU_H


	)

30 
	#PPN
(
œ
Ë(((
uöçå_t
Ë÷a)Ë>> 
PTXSHIFT
)

	)

31 
	#VPN
(
œ
Ë
	`PPN
(la)

32 

	)

34 
	#PDX
(
œ
Ë((((
uöçå_t
Ë÷a)Ë>> 
PDXSHIFT
Ë& 0x3FF)

	)

35 
	#VPD
(
œ
Ë
	`PDX
(la)

36 

	)

38 
	#PTX
(
œ
Ë((((
uöçå_t
Ë÷a)Ë>> 
PTXSHIFT
Ë& 0x3FF)

	)

41 
	#PGOFF
(
œ
Ë(((
uöçå_t
Ë÷a)Ë& 0xFFF)

	)

44 
	#PGADDR
(
d
, 
t
, 
o
Ë((*Ë((dË<< 
PDXSHIFT
 | (tË<< 
PTXSHIFT
 | (o)))

	)

47 
	#NPDENTRIES
 1024

48 
	#NPTENTRIES
 1024

49 

	)

50 
	#PGSIZE
 4096

51 
	#PGSHIFT
 12

52 

	)

53 
	#PTSIZE
 (
PGSIZE
*
NPTENTRIES
)

54 
	#PTSHIFT
 22

55 

	)

56 
	#PTXSHIFT
 12

57 
	#PDXSHIFT
 22

58 

	)

60 
	#PTE_P
 0x001

61 
	#PTE_W
 0x002

62 
	#PTE_U
 0x004

63 
	#PTE_PWT
 0x008

64 
	#PTE_PCD
 0x010

65 
	#PTE_A
 0x020

66 
	#PTE_D
 0x040

67 
	#PTE_PS
 0x080

68 
	#PTE_MBZ
 0x180

69 

	)

72 
	#PTE_AVAIL
 0xE00

73 

	)

75 
	#PTE_USER
 (
PTE_AVAIL
 | 
PTE_P
 | 
PTE_W
 | 
PTE_U
)

	)

78 
	#PTE_ADDR
(
±e
Ë((
phyßddr_t
Ë’ãË& ~0xFFF)

	)

81 
	#CR0_PE
 0x00000001

82 
	#CR0_MP
 0x00000002

83 
	#CR0_EM
 0x00000004

84 
	#CR0_TS
 0x00000008

85 
	#CR0_ET
 0x00000010

86 
	#CR0_NE
 0x00000020

87 
	#CR0_WP
 0x00010000

88 
	#CR0_AM
 0x00040000

89 
	#CR0_NW
 0x20000000

90 
	#CR0_CD
 0x40000000

91 
	#CR0_PG
 0x80000000

92 

	)

93 
	#CR4_PCE
 0x00000100

94 
	#CR4_MCE
 0x00000040

95 
	#CR4_PSE
 0x00000010

96 
	#CR4_DE
 0x00000008

97 
	#CR4_TSD
 0x00000004

98 
	#CR4_PVI
 0x00000002

99 
	#CR4_VME
 0x00000001

100 

	)

102 
	#FL_CF
 0x00000001

103 
	#FL_PF
 0x00000004

104 
	#FL_AF
 0x00000010

105 
	#FL_ZF
 0x00000040

106 
	#FL_SF
 0x00000080

107 
	#FL_TF
 0x00000100

108 
	#FL_IF
 0x00000200

109 
	#FL_DF
 0x00000400

110 
	#FL_OF
 0x00000800

111 
	#FL_IOPL_MASK
 0x00003000

112 
	#FL_IOPL_0
 0x00000000

113 
	#FL_IOPL_1
 0x00001000

114 
	#FL_IOPL_2
 0x00002000

115 
	#FL_IOPL_3
 0x00003000

116 
	#FL_NT
 0x00004000

117 
	#FL_RF
 0x00010000

118 
	#FL_VM
 0x00020000

119 
	#FL_AC
 0x00040000

120 
	#FL_VIF
 0x00080000

121 
	#FL_VIP
 0x00100000

122 
	#FL_ID
 0x00200000

123 

	)

125 
	#FEC_PR
 0x1

126 
	#FEC_WR
 0x2

127 
	#FEC_U
 0x4

128 

	)

136 #ifde‡
__ASSEMBLER__


141 
	#SEG_NULL
 \

142 .
w‹d
 0, 0; \

143 .
byã
 0, 0, 0, 0

	)

144 
	#SEG
(
ty≥
,
ba£
,
lim
) \

145 .
	`w‹d
 (((
lim
Ë>> 12Ë& 0xffff), ((
ba£
) & 0xffff); \

146 .
	`byã
 (((
ba£
Ë>> 16Ë& 0xff), (0x90 | (
ty≥
)), \

147 (0xC0 | (((
lim
Ë>> 28Ë& 0xf)), (((
ba£
Ë>> 24Ë& 0xff)

	)

151 
	~<öc/ty≥s.h
>

154 
	sSegdesc
 {

155 
	msd_lim_15_0
 : 16;

156 
	msd_ba£_15_0
 : 16;

157 
	msd_ba£_23_16
 : 8;

158 
	msd_ty≥
 : 4;

159 
	msd_s
 : 1;

160 
	msd_d∂
 : 2;

161 
	msd_p
 : 1;

162 
	msd_lim_19_16
 : 4;

163 
	msd_avl
 : 1;

164 
	msd_rsv1
 : 1;

165 
	msd_db
 : 1;

166 
	msd_g
 : 1;

167 
	msd_ba£_31_24
 : 8;

170 
	#SEG_NULL
 (
Segdesc
){ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 }

	)

172 
	#SEG_FAULT
 (
Segdesc
){ 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0 }

	)

174 
	#SEG
(
ty≥
, 
ba£
, 
lim
, 
d∂
Ë(
Segdesc
) \

175 { ((
lim
Ë>> 12Ë& 0xffff, (
ba£
) & 0xffff, ((base) >> 16) & 0xff, \

176 
ty≥
, 1, 
d∂
, 1, (Ë(
lim
) >> 28, 0, 0, 1, 1, \

177 (Ë(
ba£
Ë>> 24 }

	)

178 
	#SEG16
(
ty≥
, 
ba£
, 
lim
, 
d∂
Ë(
Segdesc
) \

179 { (
lim
Ë& 0xffff, (
ba£
) & 0xffff, ((base) >> 16) & 0xff, \

180 
ty≥
, 1, 
d∂
, 1, (Ë(
lim
) >> 16, 0, 0, 1, 0, \

181 (Ë(
ba£
Ë>> 24 }

	)

186 
	#STA_X
 0x8

187 
	#STA_E
 0x4

188 
	#STA_C
 0x4

189 
	#STA_W
 0x2

190 
	#STA_R
 0x2

191 
	#STA_A
 0x1

192 

	)

194 
	#STS_T16A
 0x1

195 
	#STS_LDT
 0x2

196 
	#STS_T16B
 0x3

197 
	#STS_CG16
 0x4

198 
	#STS_TG
 0x5

199 
	#STS_IG16
 0x6

200 
	#STS_TG16
 0x7

201 
	#STS_T32A
 0x9

202 
	#STS_T32B
 0xB

203 
	#STS_CG32
 0xC

204 
	#STS_IG32
 0xE

205 
	#STS_TG32
 0xF

206 

	)

214 #i‚de‡
__ASSEMBLER__


217 
	sTask°©e
 {

218 
uöt32_t
 
	mts_lök
;

219 
uöçå_t
 
	mts_e•0
;

220 
uöt16_t
 
	mts_ss0
;

221 
uöt16_t
 
	mts_∑ddög1
;

222 
uöçå_t
 
	mts_e•1
;

223 
uöt16_t
 
	mts_ss1
;

224 
uöt16_t
 
	mts_∑ddög2
;

225 
uöçå_t
 
	mts_e•2
;

226 
uöt16_t
 
	mts_ss2
;

227 
uöt16_t
 
	mts_∑ddög3
;

228 
phyßddr_t
 
	mts_¸3
;

229 
uöçå_t
 
	mts_eù
;

230 
uöt32_t
 
	mts_eÊags
;

231 
uöt32_t
 
	mts_óx
;

232 
uöt32_t
 
	mts_ecx
;

233 
uöt32_t
 
	mts_edx
;

234 
uöt32_t
 
	mts_ebx
;

235 
uöçå_t
 
	mts_e•
;

236 
uöçå_t
 
	mts_ebp
;

237 
uöt32_t
 
	mts_esi
;

238 
uöt32_t
 
	mts_edi
;

239 
uöt16_t
 
	mts_es
;

240 
uöt16_t
 
	mts_∑ddög4
;

241 
uöt16_t
 
	mts_cs
;

242 
uöt16_t
 
	mts_∑ddög5
;

243 
uöt16_t
 
	mts_ss
;

244 
uöt16_t
 
	mts_∑ddög6
;

245 
uöt16_t
 
	mts_ds
;

246 
uöt16_t
 
	mts_∑ddög7
;

247 
uöt16_t
 
	mts_fs
;

248 
uöt16_t
 
	mts_∑ddög8
;

249 
uöt16_t
 
	mts_gs
;

250 
uöt16_t
 
	mts_∑ddög9
;

251 
uöt16_t
 
	mts_ldt
;

252 
uöt16_t
 
	mts_∑ddög10
;

253 
uöt16_t
 
	mts_t
;

254 
uöt16_t
 
	mts_iomb
;

258 
	sG©edesc
 {

259 
	mgd_off_15_0
 : 16;

260 
	mgd_ss
 : 16;

261 
	mgd_¨gs
 : 5;

262 
	mgd_rsv1
 : 3;

263 
	mgd_ty≥
 : 4;

264 
	mgd_s
 : 1;

265 
	mgd_d∂
 : 2;

266 
	mgd_p
 : 1;

267 
	mgd_off_31_16
 : 16;

277 
	#SETGATE
(
g©e
, 
i°øp
, 
£l
, 
off
, 
d∂
) \

279 (
g©e
).
gd_off_15_0
 = (
uöt32_t
Ë(
off
) & 0xffff; \

280 (
g©e
).
gd_ss
 = (
£l
); \

281 (
g©e
).
gd_¨gs
 = 0; \

282 (
g©e
).
gd_rsv1
 = 0; \

283 (
g©e
).
gd_ty≥
 = (
i°øp
Ë? 
STS_TG32
 : 
STS_IG32
; \

284 (
g©e
).
gd_s
 = 0; \

285 (
g©e
).
gd_d∂
 = (
d∂
); \

286 (
g©e
).
gd_p
 = 1; \

287 (
g©e
).
gd_off_31_16
 = (
uöt32_t
Ë(
off
) >> 16; \

288 }

	)

291 
	#SETCALLGATE
(
g©e
, 
ss
, 
off
, 
d∂
) \

293 (
g©e
).
gd_off_15_0
 = (
uöt32_t
Ë(
off
) & 0xffff; \

294 (
g©e
).
gd_ss
 = (
ss
); \

295 (
g©e
).
gd_¨gs
 = 0; \

296 (
g©e
).
gd_rsv1
 = 0; \

297 (
g©e
).
gd_ty≥
 = 
STS_CG32
; \

298 (
g©e
).
gd_s
 = 0; \

299 (
g©e
).
gd_d∂
 = (
d∂
); \

300 (
g©e
).
gd_p
 = 1; \

301 (
g©e
).
gd_off_31_16
 = (
uöt32_t
Ë(
off
) >> 16; \

302 }

	)

305 
	sP£udodesc
 {

306 
uöt16_t
 
	mpd_lim
;

307 
uöt32_t
 
	mpd_ba£
;

308 } 
__©åibuã__
 ((
∑cked
));

	@inc/queue.h

35 #i‚de‡
JOS_INC_QUEUE_H


36 
	#JOS_INC_QUEUE_H


	)

52 
	sFrob


54 
	m‰obozz
;

55 
LIST_ENTRY
(
Frob
Ë
	m‰ob_lök
;

58 
	$LIST_HEAD
(
Frob_li°
, 
Frob
)

60 
Frob_li°
 
Êi°
;

62 
	`LIST_INIT
(&
Êi°
);

63 
Êi°
 = 
	`LIST_HEAD_INITIALIZER
(&flist);

65 if(
	$LIST_EMPTY
(&
Êi°
))

66 
	`¥ötf
("list isÉmpty\n");

68 
Frob
 *
f
 = 
	`LIST_FIRST
(&
Êi°
);

69 
f
 = 
	`LIST_NEXT
(f, 
‰ob_lök
);

70 
f
 = 
	`LIST_NEXT
(f, 
‰ob_lök
);

72 
f
=
	`LIST_FIRST
(&
Êi°
); f != 0;

73 
f
 = 
	$LIST_NEXT
(
f
, 
‰ob_lök
))

74 
	`¥ötf
("‡%d\n", 
f
->
‰obozz
);

76 
	$LIST_FOREACH
(
f
, &
Êi°
, 
‰ob_lök
)

77 
	`¥ötf
("‡%d\n", 
f
->
‰obozz
);

79 
f
 = 
	`LIST_NEXT
(
	`LIST_FIRST
(&
Êi°
));

80 
	`LIST_INSERT_AFTER
(
f
, 
g
, 
‰ob_lök
);

81 
	`LIST_REMOVE
(
g
, 
‰ob_lök
);

82 
	`LIST_INSERT_BEFORE
(
f
, 
g
, 
‰ob_lök
);

83 
	`LIST_REMOVE
(
g
, 
‰ob_lök
);

84 
	`LIST_INSERT_HEAD
(&
Êi°
, 
g
, 
‰ob_lök
);

109 
	#LIST_HEAD
(
«me
, 
ty≥
) \

110 
	s«me
 { \

111 
ty≥
 *
lh_fú°
; \

112 }

	)

118 
	#LIST_HEAD_INITIALIZER
(
hód
) \

119 { 
NULL
 
	}

	)
}

129 
	#LIST_ENTRY
(
ty≥
) \

131 
ty≥
 *
À_√xt
; \

132 
ty≥
 **
À_¥ev
; \

133 }

	)

142 
	#LIST_EMPTY
(
hód
Ë((hód)->
lh_fú°
 =
NULL
)

	)

147 
	#LIST_FIRST
(
hód
Ë((hód)->
lh_fú°
)

	)

153 
	#LIST_NEXT
(
ñm
, 
fõld
Ë(”lm)->fõld.
À_√xt
)

	)

160 
	#LIST_FOREACH
(
v¨
, 
hód
, 
fõld
) \

161 (
v¨
Ë
	`LIST_FIRST
((
hód
)); \

162 (
v¨
); \

163 (
v¨
Ë
	`LIST_NEXT
((v¨), 
fõld
))

	)

168 
	#LIST_INIT
(
hód
) do { \

169 
	`LIST_FIRST
((
hód
)Ë
NULL
; \

170 } 0)

	)

177 
	#LIST_INSERT_AFTER
(
li°ñm
, 
ñm
, 
fõld
) do { \

178 i‡((
	`LIST_NEXT
((
ñm
), 
fõld
ËLIST_NEXT((
li°ñm
), fõld)Ë!
NULL
)\

179 
	`LIST_NEXT
((
li°ñm
), 
fõld
)->fõld.
À_¥ev
 = \

180 &
	`LIST_NEXT
((
ñm
), 
fõld
); \

181 
	`LIST_NEXT
((
li°ñm
), 
fõld
Ë(
ñm
); \

182 (
ñm
)->
fõld
.
À_¥ev
 = &
	`LIST_NEXT
((
li°ñm
), field); \

183 } 0)

	)

190 
	#LIST_INSERT_BEFORE
(
li°ñm
, 
ñm
, 
fõld
) do { \

191 (
ñm
)->
fõld
.
À_¥ev
 = (
li°ñm
)->field.le_prev; \

192 
	`LIST_NEXT
((
ñm
), 
fõld
Ë(
li°ñm
); \

193 *(
li°ñm
)->
fõld
.
À_¥ev
 = (
ñm
); \

194 (
li°ñm
)->
fõld
.
À_¥ev
 = &
	`LIST_NEXT
((
ñm
), field); \

195 } 0)

	)

201 
	#LIST_INSERT_HEAD
(
hód
, 
ñm
, 
fõld
) do { \

202 i‡((
	`LIST_NEXT
((
ñm
), 
fõld
Ë
	`LIST_FIRST
((
hód
))Ë!
NULL
) \

203 
	`LIST_FIRST
((
hód
))->
fõld
.
À_¥ev
 = &
	`LIST_NEXT
((
ñm
), field);\

204 
	`LIST_FIRST
((
hód
)Ë(
ñm
); \

205 (
ñm
)->
fõld
.
À_¥ev
 = &
	`LIST_FIRST
((
hód
)); \

206 } 0)

	)

212 
	#LIST_REMOVE
(
ñm
, 
fõld
) do { \

213 i‡(
	`LIST_NEXT
((
ñm
), 
fõld
Ë!
NULL
) \

214 
	`LIST_NEXT
((
ñm
), 
fõld
)->fõld.
À_¥ev
 = \

215 (
ñm
)->
fõld
.
À_¥ev
; \

216 *(
ñm
)->
fõld
.
À_¥ev
 = 
	`LIST_NEXT
((elm), field); \

217 } 0)

	)

	@inc/stab.h

1 #i‚de‡
JOS_STAB_H


2 
	#JOS_STAB_H


	)

3 
	~<öc/ty≥s.h
>

15 
	#N_GSYM
 0x20

16 
	#N_FNAME
 0x22

17 
	#N_FUN
 0x24

18 
	#N_STSYM
 0x26

19 
	#N_LCSYM
 0x28

20 
	#N_MAIN
 0x2a

21 
	#N_PC
 0x30

22 
	#N_RSYM
 0x40

23 
	#N_SLINE
 0x44

24 
	#N_DSLINE
 0x46

25 
	#N_BSLINE
 0x48

26 
	#N_SSYM
 0x60

27 
	#N_SO
 0x64

28 
	#N_LSYM
 0x80

29 
	#N_BINCL
 0x82

30 
	#N_SOL
 0x84

31 
	#N_PSYM
 0xa0

32 
	#N_EINCL
 0xa2

33 
	#N_ENTRY
 0xa4

34 
	#N_LBRAC
 0xc0

35 
	#N_EXCL
 0xc2

36 
	#N_RBRAC
 0xe0

37 
	#N_BCOMM
 0xe2

38 
	#N_ECOMM
 0xe4

39 
	#N_ECOML
 0xe8

40 
	#N_LENG
 0xfe

41 

	)

43 
	sSèb
 {

44 
uöt32_t
 
	mn_°rx
;

45 
uöt8_t
 
	mn_ty≥
;

46 
uöt8_t
 
	mn_Ÿhî
;

47 
uöt16_t
 
	mn_desc
;

48 
uöçå_t
 
	mn_vÆue
;

	@inc/stdarg.h

3 #i‚de‡
JOS_INC_STDARG_H


4 
	#JOS_INC_STDARG_H


	)

6 *
	tva_li°
;

8 
	#__va_size
(
ty≥
) \

9 ((((
ty≥
Ë+ (Ë- 1Ë/ ()Ë* ())

	)

11 
	#va_°¨t
(
≠
, 
œ°
) \

12 ((
≠
Ë(
va_li°
)&(
œ°
Ë+ 
	`__va_size
÷a°))

	)

14 
	#va_¨g
(
≠
, 
ty≥
) \

15 (*(
ty≥
 *)((
≠
Ë+
	`__va_size
—y≥), (≠Ë- __va_size—y≥)))

	)

17 
	#va_íd
(
≠
Ë(()0)

	)

	@inc/stdio.h

1 #i‚de‡
JOS_INC_STDIO_H


2 
	#JOS_INC_STDIO_H


	)

4 
	~<öc/°d¨g.h
>

6 #i‚de‡
NULL


7 
	#NULL
 ((*Ë0)

	)

11 
˝utch¨
(
c
);

12 
gëch¨
();

13 
isc⁄s
(
fd
);

16 
¥ötfmt
((*
putch
)(, *), *
putd©
, c⁄° *
fmt
, ...);

17 
	`v¥ötfmt
((*
putch
)(, *), *
putd©
, c⁄° *
fmt
, 
va_li°
);

18 
	`¢¥ötf
(*
°r
, 
size
, c⁄° *
fmt
, ...);

19 
	`v¢¥ötf
(*
°r
, 
size
, c⁄° *
fmt
, 
va_li°
);

22 
	`˝rötf
(c⁄° *
fmt
, ...);

23 
	`v˝rötf
(c⁄° *
fmt
, 
va_li°
);

26 
	`¥ötf
(c⁄° *
fmt
, ...);

27 
	`Ârötf
(
fd
, c⁄° *
fmt
, ...);

28 
	`vÂrötf
(
fd
, c⁄° *
fmt
, 
va_li°
);

31 * 
	`ªadlöe
(c⁄° *
¥om±
);

	@inc/string.h

1 #i‚de‡
JOS_INC_STRING_H


2 
	#JOS_INC_STRING_H


	)

4 
	~<öc/ty≥s.h
>

6 
°æí
(c⁄° *
s
);

7 
°∫Àn
(c⁄° *
s
, 
size_t
 
size
);

8 * 
°r˝y
(*
d°
, c⁄° *
§c
);

9 * 
°∫˝y
(*
d°
, c⁄° *
§c
, 
size_t
 
size
);

10 
size_t
 
°æ˝y
(*
d°
, c⁄° *
§c
, size_à
size
);

11 
°rcmp
(c⁄° *
s1
, c⁄° *
s2
);

12 
°∫cmp
(c⁄° *
s1
, c⁄° *
s2
, 
size_t
 
size
);

13 * 
°rchr
(c⁄° *
s
, 
c
);

14 * 
°rföd
(c⁄° *
s
, 
c
);

16 * 
mem£t
(*
d°
, 
c
, 
size_t
 
Àn
);

18 * 
memmove
(*
d°
, c⁄° *
§c
, 
size_t
 
Àn
);

19 
memcmp
(c⁄° *
s1
, c⁄° *
s2
, 
size_t
 
Àn
);

20 * 
memföd
(c⁄° *
s
, 
c
, 
size_t
 
Àn
);

22 
°πﬁ
(c⁄° *
s
, **
íd±r
, 
ba£
);

	@inc/types.h

1 #i‚de‡
JOS_INC_TYPES_H


2 
	#JOS_INC_TYPES_H


	)

4 #i‚de‡
NULL


5 
	#NULL
 ((*Ë0)

	)

9 
	tboﬁ
;

12 
__sig√d
 
	töt8_t
;

13 
	tuöt8_t
;

14 
	töt16_t
;

15 
	tuöt16_t
;

16 
	töt32_t
;

17 
	tuöt32_t
;

18 
	töt64_t
;

19 
	tuöt64_t
;

25 
öt32_t
 
	töçå_t
;

26 
uöt32_t
 
	tuöçå_t
;

27 
uöt32_t
 
	tphyßddr_t
;

30 
uöt32_t
 
	tµn_t
;

33 
uöt32_t
 
	tsize_t
;

36 
öt32_t
 
	tssize_t
;

39 
öt32_t
 
	toff_t
;

42 
	#MIN
(
_a
, 
_b
) \

44 
	`ty≥of
(
_a
Ë
__a
 = (_a); \

45 
	`ty≥of
(
_b
Ë
__b
 = (_b); \

46 
__a
 <
__b
 ? __a : __b; \

47 })

	)

48 
	#MAX
(
_a
, 
_b
) \

50 
	`ty≥of
(
_a
Ë
__a
 = (_a); \

51 
	`ty≥of
(
_b
Ë
__b
 = (_b); \

52 
__a
 >
__b
 ? __a : __b; \

53 })

	)

57 
	#ROUNDDOWN
(
a
, 
n
) \

59 
uöt32_t
 
__a
 = (uöt32_tË(
a
); \

60 (
	`ty≥of
(
a
)Ë(
__a
 - __®% (
n
)); \

61 })

	)

63 
	#ROUNDUP
(
a
, 
n
) \

65 
uöt32_t
 
__n
 = (uöt32_tË(
n
); \

66 (
	`ty≥of
(
a
)Ë(
	`ROUNDDOWN
((
uöt32_t
Ë◊Ë+ 
__n
 - 1, __n)); \

67 })

	)

70 
	#off£tof
(
ty≥
, 
membî
Ë((
size_t
Ë(&(—y≥*)0)->membî))

	)

	@inc/x86.h

1 #i‚de‡
JOS_INC_X86_H


2 
	#JOS_INC_X86_H


	)

4 
	~<öc/ty≥s.h
>

6 
__ölöe
 
	$bªakpoöt
(Ë
	`__©åibuã__
((
Æways_ölöe
));

7 
__ölöe
 
uöt8_t
 
	$öb
(
p‹t
Ë
	`__©åibuã__
((
Æways_ölöe
));

8 
__ölöe
 
	$ösb
(
p‹t
, *
addr
, 
˙t
Ë
	`__©åibuã__
((
Æways_ölöe
));

9 
__ölöe
 
uöt16_t
 
	$öw
(
p‹t
Ë
	`__©åibuã__
((
Æways_ölöe
));

10 
__ölöe
 
	$ösw
(
p‹t
, *
addr
, 
˙t
Ë
	`__©åibuã__
((
Æways_ölöe
));

11 
__ölöe
 
uöt32_t
 
	$öl
(
p‹t
Ë
	`__©åibuã__
((
Æways_ölöe
));

12 
__ölöe
 
	$ö¶
(
p‹t
, *
addr
, 
˙t
Ë
	`__©åibuã__
((
Æways_ölöe
));

13 
__ölöe
 
	$outb
(
p‹t
, 
uöt8_t
 
d©a
Ë
	`__©åibuã__
((
Æways_ölöe
));

14 
__ölöe
 
	$outsb
(
p‹t
, c⁄° *
addr
, 
˙t
Ë
	`__©åibuã__
((
Æways_ölöe
));

15 
__ölöe
 
	$outw
(
p‹t
, 
uöt16_t
 
d©a
Ë
	`__©åibuã__
((
Æways_ölöe
));

16 
__ölöe
 
	$outsw
(
p‹t
, c⁄° *
addr
, 
˙t
Ë
	`__©åibuã__
((
Æways_ölöe
));

17 
__ölöe
 
	$out¶
(
p‹t
, c⁄° *
addr
, 
˙t
Ë
	`__©åibuã__
((
Æways_ölöe
));

18 
__ölöe
 
	$oué
(
p‹t
, 
uöt32_t
 
d©a
Ë
	`__©åibuã__
((
Æways_ölöe
));

19 
__ölöe
 
	$övÕg
(*
addr
Ë
	`__©åibuã__
((
Æways_ölöe
));

20 
__ölöe
 
	$lidt
(*
p
Ë
	`__©åibuã__
((
Æways_ölöe
));

21 
__ölöe
 
	$Œdt
(
uöt16_t
 
£l
Ë
	`__©åibuã__
((
Æways_ölöe
));

22 
__ölöe
 
	$…r
(
uöt16_t
 
£l
Ë
	`__©åibuã__
((
Æways_ölöe
));

23 
__ölöe
 
	$l¸0
(
uöt32_t
 
vÆ
Ë
	`__©åibuã__
((
Æways_ölöe
));

24 
__ölöe
 
uöt32_t
 
	$r¸0
(Ë
	`__©åibuã__
((
Æways_ölöe
));

25 
__ölöe
 
uöt32_t
 
	$r¸2
(Ë
	`__©åibuã__
((
Æways_ölöe
));

26 
__ölöe
 
	$l¸3
(
uöt32_t
 
vÆ
Ë
	`__©åibuã__
((
Æways_ölöe
));

27 
__ölöe
 
uöt32_t
 
	$r¸3
(Ë
	`__©åibuã__
((
Æways_ölöe
));

28 
__ölöe
 
	$l¸4
(
uöt32_t
 
vÆ
Ë
	`__©åibuã__
((
Æways_ölöe
));

29 
__ölöe
 
uöt32_t
 
	$r¸4
(Ë
	`__©åibuã__
((
Æways_ölöe
));

30 
__ölöe
 
	$ébÊush
(Ë
	`__©åibuã__
((
Æways_ölöe
));

31 
__ölöe
 
uöt32_t
 
	$ªad_eÊags
(Ë
	`__©åibuã__
((
Æways_ölöe
));

32 
__ölöe
 
	$wrôe_eÊags
(
uöt32_t
 
eÊags
Ë
	`__©åibuã__
((
Æways_ölöe
));

33 
__ölöe
 
uöt32_t
 
	$ªad_ebp
(Ë
	`__©åibuã__
((
Æways_ölöe
));

34 
__ölöe
 
uöt32_t
 
	$ªad_e•
(Ë
	`__©åibuã__
((
Æways_ölöe
));

35 
__ölöe
 
	`˝uid
(
uöt32_t
 
öfo
, uöt32_à*
óxp
, uöt32_à*
ebxp
, uöt32_à*
ecxp
, uöt32_à*
edxp
);

36 
__ölöe
 
uöt64_t
 
	$ªad_tsc
(Ë
	`__©åibuã__
((
Æways_ölöe
));

38 
__ölöe
 

39 
	$bªakpoöt
()

41 
__asm
 
	`__vﬁ©ûe
("int3");

42 
	}
}

44 
__ölöe
 
uöt8_t


45 
	$öb
(
p‹t
)

47 
uöt8_t
 
d©a
;

48 
__asm
 
	`__vﬁ©ûe
("öb %w1,%0" : "˜" (
d©a
Ë: "d" (
p‹t
));

49  
d©a
;

50 
	}
}

52 
__ölöe
 

53 
	$ösb
(
p‹t
, *
addr
, 
˙t
)

55 
__asm
 
	`__vﬁ©ûe
("cld\n\trepne\n\tinsb" :

56 "=D" (
addr
), "=c" (
˙t
) :

57 "d" (
p‹t
), "0" (
addr
), "1" (
˙t
) :

59 
	}
}

61 
__ölöe
 
uöt16_t


62 
	$öw
(
p‹t
)

64 
uöt16_t
 
d©a
;

65 
__asm
 
	`__vﬁ©ûe
("öw %w1,%0" : "˜" (
d©a
Ë: "d" (
p‹t
));

66  
d©a
;

67 
	}
}

69 
__ölöe
 

70 
	$ösw
(
p‹t
, *
addr
, 
˙t
)

72 
__asm
 
	`__vﬁ©ûe
("cld\n\trepne\n\tinsw" :

73 "=D" (
addr
), "=c" (
˙t
) :

74 "d" (
p‹t
), "0" (
addr
), "1" (
˙t
) :

76 
	}
}

78 
__ölöe
 
uöt32_t


79 
	$öl
(
p‹t
)

81 
uöt32_t
 
d©a
;

82 
__asm
 
	`__vﬁ©ûe
("ö»%w1,%0" : "˜" (
d©a
Ë: "d" (
p‹t
));

83  
d©a
;

84 
	}
}

86 
__ölöe
 
	$ö¶
(
p‹t
, *
addr
, 
˙t
)

88 
__asm
 
	`__vﬁ©ûe
("cld\n\trepne\n\tinsl" :

89 "=D" (
addr
), "=c" (
˙t
) :

90 "d" (
p‹t
), "0" (
addr
), "1" (
˙t
) :

92 
	}
}

94 
__ölöe
 
	$outb
(
p‹t
, 
uöt8_t
 
d©a
)

96 
__asm
 
	`__vﬁ©ûe
("outb %0,%w1" : : "a" (
d©a
), "d" (
p‹t
));

97 
	}
}

99 
__ölöe
 

100 
	$outsb
(
p‹t
, c⁄° *
addr
, 
˙t
)

102 
__asm
 
	`__vﬁ©ûe
("cld\n\trepne\n\toutsb" :

103 "=S" (
addr
), "=c" (
˙t
) :

104 "d" (
p‹t
), "0" (
addr
), "1" (
˙t
) :

106 
	}
}

108 
__ölöe
 

109 
	$outw
(
p‹t
, 
uöt16_t
 
d©a
)

111 
__asm
 
	`__vﬁ©ûe
("outw %0,%w1" : : "a" (
d©a
), "d" (
p‹t
));

112 
	}
}

114 
__ölöe
 

115 
	$outsw
(
p‹t
, c⁄° *
addr
, 
˙t
)

117 
__asm
 
	`__vﬁ©ûe
("cld\n\trepne\n\toutsw" :

118 "=S" (
addr
), "=c" (
˙t
) :

119 "d" (
p‹t
), "0" (
addr
), "1" (
˙t
) :

121 
	}
}

123 
__ölöe
 

124 
	$out¶
(
p‹t
, c⁄° *
addr
, 
˙t
)

126 
__asm
 
	`__vﬁ©ûe
("cld\n\trepne\n\toutsl" :

127 "=S" (
addr
), "=c" (
˙t
) :

128 "d" (
p‹t
), "0" (
addr
), "1" (
˙t
) :

130 
	}
}

132 
__ölöe
 

133 
	$oué
(
p‹t
, 
uöt32_t
 
d©a
)

135 
__asm
 
	`__vﬁ©ûe
("oué %0,%w1" : : "a" (
d©a
), "d" (
p‹t
));

136 
	}
}

138 
__ölöe
 

139 
	$övÕg
(*
addr
)

141 
__asm
 
	`__vﬁ©ûe
("övÕg (%0)" : : "r" (
addr
) : "memory");

142 
	}
}

144 
__ölöe
 

145 
	$lidt
(*
p
)

147 
__asm
 
	`__vﬁ©ûe
("lidà(%0)" : : "r" (
p
));

148 
	}
}

150 
__ölöe
 

151 
	$Œdt
(
uöt16_t
 
£l
)

153 
__asm
 
	`__vﬁ©ûe
("Œdà%0" : : "r" (
£l
));

154 
	}
}

156 
__ölöe
 

157 
	$…r
(
uöt16_t
 
£l
)

159 
__asm
 
	`__vﬁ©ûe
("…∏%0" : : "r" (
£l
));

160 
	}
}

162 
__ölöe
 

163 
	$l¸0
(
uöt32_t
 
vÆ
)

165 
__asm
 
	`__vﬁ©ûe
("mov»%0,%%¸0" : : "r" (
vÆ
));

166 
	}
}

168 
__ölöe
 
uöt32_t


169 
	$r¸0
()

171 
uöt32_t
 
vÆ
;

172 
__asm
 
	`__vﬁ©ûe
("mov»%%¸0,%0" : "Ù" (
vÆ
));

173  
vÆ
;

174 
	}
}

176 
__ölöe
 
uöt32_t


177 
	$r¸2
()

179 
uöt32_t
 
vÆ
;

180 
__asm
 
	`__vﬁ©ûe
("mov»%%¸2,%0" : "Ù" (
vÆ
));

181  
vÆ
;

182 
	}
}

184 
__ölöe
 

185 
	$l¸3
(
uöt32_t
 
vÆ
)

187 
__asm
 
	`__vﬁ©ûe
("mov»%0,%%¸3" : : "r" (
vÆ
));

188 
	}
}

190 
__ölöe
 
uöt32_t


191 
	$r¸3
()

193 
uöt32_t
 
vÆ
;

194 
__asm
 
	`__vﬁ©ûe
("mov»%%¸3,%0" : "Ù" (
vÆ
));

195  
vÆ
;

196 
	}
}

198 
__ölöe
 

199 
	$l¸4
(
uöt32_t
 
vÆ
)

201 
__asm
 
	`__vﬁ©ûe
("mov»%0,%%¸4" : : "r" (
vÆ
));

202 
	}
}

204 
__ölöe
 
uöt32_t


205 
	$r¸4
()

207 
uöt32_t
 
¸4
;

208 
__asm
 
	`__vﬁ©ûe
("mov»%%¸4,%0" : "Ù" (
¸4
));

209  
¸4
;

210 
	}
}

212 
__ölöe
 

213 
	$ébÊush
()

215 
uöt32_t
 
¸3
;

216 
__asm
 
	`__vﬁ©ûe
("mov»%%¸3,%0" : "Ù" (
¸3
));

217 
__asm
 
	`__vﬁ©ûe
("mov»%0,%%¸3" : : "r" (
¸3
));

218 
	}
}

220 
__ölöe
 
uöt32_t


221 
	$ªad_eÊags
()

223 
uöt32_t
 
eÊags
;

224 
__asm
 
	`__vﬁ©ûe
("pushÊ;Ö›»%0" : "Ù" (
eÊags
));

225  
eÊags
;

226 
	}
}

228 
__ölöe
 

229 
	$wrôe_eÊags
(
uöt32_t
 
eÊags
)

231 
__asm
 
	`__vﬁ©ûe
("push»%0;Ö›Ê" : : "r" (
eÊags
));

232 
	}
}

234 
__ölöe
 
uöt32_t


235 
	$ªad_ebp
()

237 
uöt32_t
 
ebp
;

238 
__asm
 
	`__vﬁ©ûe
("mov»%%ebp,%0" : "Ù" (
ebp
));

239  
ebp
;

240 
	}
}

242 
__ölöe
 
uöt32_t


243 
	$ªad_e•
()

245 
uöt32_t
 
e•
;

246 
__asm
 
	`__vﬁ©ûe
("mov»%%e•,%0" : "Ù" (
e•
));

247  
e•
;

248 
	}
}

250 
__ölöe
 

251 
	$˝uid
(
uöt32_t
 
öfo
, uöt32_à*
óxp
, uöt32_à*
ebxp
, uöt32_à*
ecxp
, uöt32_à*
edxp
)

253 
uöt32_t
 
óx
, 
ebx
, 
ecx
, 
edx
;

254 
asm
 volatile("cpuid"

255 : "˜" (
óx
), "=b" (
ebx
), "=c" (
ecx
), "=d" (
edx
)

256 : "a" (
öfo
));

257 i‡(
óxp
)

258 *
óxp
 = 
óx
;

259 i‡(
ebxp
)

260 *
ebxp
 = 
ebx
;

261 i‡(
ecxp
)

262 *
ecxp
 = 
ecx
;

263 i‡(
edxp
)

264 *
edxp
 = 
edx
;

265 
	}
}

267 
__ölöe
 
uöt64_t


268 
	$ªad_tsc
()

270 
uöt64_t
 
tsc
;

271 
__asm
 
	`__vﬁ©ûe
("rdtsc" : "=A" (
tsc
));

272  
tsc
;

273 
	}
}

	@kern/console.c

3 
	~<öc/x86.h
>

4 
	~<öc/memœyout.h
>

5 
	~<öc/kbdªg.h
>

6 
	~<öc/°rög.h
>

7 
	~<öc/as£π.h
>

9 
	~<kîn/c⁄sﬁe.h
>

11 
c⁄s_öå
((*
¥oc
)());

12 
	`c⁄s_putc
(
c
);

15 
	$dñay
()

17 
	`öb
(0x84);

18 
	`öb
(0x84);

19 
	`öb
(0x84);

20 
	`öb
(0x84);

21 
	}
}

25 
	#COM1
 0x3F8

	)

27 
	#COM_RX
 0

28 
	#COM_TX
 0

29 
	#COM_DLL
 0

30 
	#COM_DLM
 1

31 
	#COM_IER
 1

32 
	#COM_IER_RDI
 0x01

33 
	#COM_IIR
 2

34 
	#COM_FCR
 2

35 
	#COM_LCR
 3

36 
	#COM_LCR_DLAB
 0x80

37 
	#COM_LCR_WLEN8
 0x03

38 
	#COM_MCR
 4

39 
	#COM_MCR_RTS
 0x02

40 
	#COM_MCR_DTR
 0x01

41 
	#COM_MCR_OUT2
 0x08

42 
	#COM_LSR
 5

43 
	#COM_LSR_DATA
 0x01

44 
	#COM_LSR_TXRDY
 0x20

45 
	#COM_LSR_TSRE
 0x40

46 

	)

47 
boﬁ
 
	g£rül_exi°s
;

49 
	$£rül_¥oc_d©a
()

51 i‡(!(
	`öb
(
COM1
+
COM_LSR
Ë& 
COM_LSR_DATA
))

53  
	`öb
(
COM1
+
COM_RX
);

54 
	}
}

56 
	$£rül_öå
()

58 i‡(
£rül_exi°s
)

59 
	`c⁄s_öå
(
£rül_¥oc_d©a
);

60 
	}
}

62 
	$£rül_putc
(
c
)

64 
i
;

66 
i
 = 0;

67 !(
	`öb
(
COM1
 + 
COM_LSR
Ë& 
COM_LSR_TXRDY
Ë&& 
i
 < 12800;

68 
i
++)

69 
	`dñay
();

71 
	`outb
(
COM1
 + 
COM_TX
, 
c
);

72 
	}
}

75 
	$£rül_öô
()

78 
	`outb
(
COM1
+
COM_FCR
, 0);

81 
	`outb
(
COM1
+
COM_LCR
, 
COM_LCR_DLAB
);

82 
	`outb
(
COM1
+
COM_DLL
, (
uöt8_t
) (115200 / 9600));

83 
	`outb
(
COM1
+
COM_DLM
, 0);

86 
	`outb
(
COM1
+
COM_LCR
, 
COM_LCR_WLEN8
 & ~
COM_LCR_DLAB
);

89 
	`outb
(
COM1
+
COM_MCR
, 0);

91 
	`outb
(
COM1
+
COM_IER
, 
COM_IER_RDI
);

95 
£rül_exi°s
 = (
	`öb
(
COM1
+
COM_LSR
) != 0xFF);

96 (Ë
	`öb
(
COM1
+
COM_IIR
);

97 (Ë
	`öb
(
COM1
+
COM_RX
);

99 
	}
}

108 
	$Õt_putc
(
c
)

110 
i
;

112 
i
 = 0; !(
	`öb
(0x378+1) & 0x80) && i < 12800; i++)

113 
	`dñay
();

114 
	`outb
(0x378+0, 
c
);

115 
	`outb
(0x378+2, 0x08|0x04|0x01);

116 
	`outb
(0x378+2, 0x08);

117 
	}
}

124 
	gaddr_6845
;

125 
uöt16_t
 *
	g¸t_buf
;

126 
uöt16_t
 
	g¸t_pos
;

129 
	$cga_öô
()

131 vﬁ©ûê
uöt16_t
 *
˝
;

132 
uöt16_t
 
was
;

133 
pos
;

135 
˝
 = (
uöt16_t
*Ë(
KERNBASE
 + 
CGA_BUF
);

136 
was
 = *
˝
;

137 *
˝
 = (
uöt16_t
) 0xA55A;

138 i‡(*
˝
 != 0xA55A) {

139 
˝
 = (
uöt16_t
*Ë(
KERNBASE
 + 
MONO_BUF
);

140 
addr_6845
 = 
MONO_BASE
;

142 *
˝
 = 
was
;

143 
addr_6845
 = 
CGA_BASE
;

147 
	`outb
(
addr_6845
, 14);

148 
pos
 = 
	`öb
(
addr_6845
 + 1) << 8;

149 
	`outb
(
addr_6845
, 15);

150 
pos
 |
	`öb
(
addr_6845
 + 1);

152 
¸t_buf
 = (
uöt16_t
*Ë
˝
;

153 
¸t_pos
 = 
pos
;

154 
	}
}

158 
	$cga_putc
(
c
)

161 i‡(!(
c
 & ~0xFF))

162 
c
 |= 0x0700;

164 
c
 & 0xff) {

166 i‡(
¸t_pos
 > 0) {

167 
¸t_pos
--;

168 
¸t_buf
[
¸t_pos
] = (
c
 & ~0xff) | ' ';

172 
¸t_pos
 +
CRT_COLS
;

175 
¸t_pos
 -(¸t_po†% 
CRT_COLS
);

178 
	`c⁄s_putc
(' ');

179 
	`c⁄s_putc
(' ');

180 
	`c⁄s_putc
(' ');

181 
	`c⁄s_putc
(' ');

182 
	`c⁄s_putc
(' ');

185 
¸t_buf
[
¸t_pos
++] = 
c
;

190 i‡(
¸t_pos
 >
CRT_SIZE
) {

191 
i
;

193 
	`memmove
(
¸t_buf
, cπ_bu‡+ 
CRT_COLS
, (
CRT_SIZE
 - CRT_COLSË* (
uöt16_t
));

194 
i
 = 
CRT_SIZE
 - 
CRT_COLS
; i < CRT_SIZE; i++)

195 
¸t_buf
[
i
] = 0x0700 | ' ';

196 
¸t_pos
 -
CRT_COLS
;

200 
	`outb
(
addr_6845
, 14);

201 
	`outb
(
addr_6845
 + 1, 
¸t_pos
 >> 8);

202 
	`outb
(
addr_6845
, 15);

203 
	`outb
(
addr_6845
 + 1, 
¸t_pos
);

204 
	}
}

209 
	#NO
 0

	)

211 
	#SHIFT
 (1<<0)

	)

212 
	#CTL
 (1<<1)

	)

213 
	#ALT
 (1<<2)

	)

215 
	#CAPSLOCK
 (1<<3)

	)

216 
	#NUMLOCK
 (1<<4)

	)

217 
	#SCROLLLOCK
 (1<<5)

	)

219 
	#E0ESC
 (1<<6)

	)

221 
uöt8_t
 
	gshi·code
[256] =

223 [0x1D] = 
CTL
,

224 [0x2A] = 
SHIFT
,

225 [0x36] = 
SHIFT
,

226 [0x38] = 
ALT
,

227 [0x9D] = 
CTL
,

228 [0xB8] = 
ALT


231 
uöt8_t
 
	gtoggÀcode
[256] =

233 [0x3A] = 
CAPSLOCK
,

234 [0x45] = 
NUMLOCK
,

235 [0x46] = 
SCROLLLOCK


238 
uöt8_t
 
	gn‹mÆm≠
[256] =

240 
NO
, 0x1B, '1', '2', '3', '4', '5', '6',

243 'o', 'p', '[', ']', '\n', 
NO
, 'a', 's',

245 '\'', '`', 
NO
, '\\', 'z', 'x', 'c', 'v',

246 'b', 'n', 'm', ',', '.', '/', 
NO
, '*',

247 
NO
, ' ', NO, NO, NO, NO, NO, NO,

248 
NO
, NO, NO, NO, NO, NO, NO, '7',

250 '2', '3', '0', '.', 
NO
, NO, NO, NO,

251 [0xC7] = 
KEY_HOME
, [0x9C] = '\n' ,

252 [0xB5] = '/' , [0xC8] = 
KEY_UP
,

253 [0xC9] = 
KEY_PGUP
, [0xCB] = 
KEY_LF
,

254 [0xCD] = 
KEY_RT
, [0xCF] = 
KEY_END
,

255 [0xD0] = 
KEY_DN
, [0xD1] = 
KEY_PGDN
,

256 [0xD2] = 
KEY_INS
, [0xD3] = 
KEY_DEL


259 
uöt8_t
 
	gshi·m≠
[256] =

261 
NO
, 033, '!', '@', '#', '$', '%', '^',

264 'O', 'P', '{', '}', '\n', 
NO
, 'A', 'S',

266 '"', '~', 
NO
, '|', 'Z', 'X', 'C', 'V',

267 'B', 'N', 'M', '<', '>', '?', 
NO
, '*',

268 
NO
, ' ', NO, NO, NO, NO, NO, NO,

269 
NO
, NO, NO, NO, NO, NO, NO, '7',

271 '2', '3', '0', '.', 
NO
, NO, NO, NO,

272 [0xC7] = 
KEY_HOME
, [0x9C] = '\n' ,

273 [0xB5] = '/' , [0xC8] = 
KEY_UP
,

274 [0xC9] = 
KEY_PGUP
, [0xCB] = 
KEY_LF
,

275 [0xCD] = 
KEY_RT
, [0xCF] = 
KEY_END
,

276 [0xD0] = 
KEY_DN
, [0xD1] = 
KEY_PGDN
,

277 [0xD2] = 
KEY_INS
, [0xD3] = 
KEY_DEL


280 
	#C
(
x
Ë(x - '@')

	)

282 
uöt8_t
 
	g˘lm≠
[256] =

284 
NO
, NO, NO, NO, NO, NO, NO, NO,

285 
NO
, NO, NO, NO, NO, NO, NO, NO,

286 
C
('Q'), C('W'), C('E'), C('R'), C('T'), C('Y'), C('U'), C('I'),

287 
C
('O'), C('P'), 
NO
, NO, '\r', NO, C('A'), C('S'),

288 
C
('D'), C('F'), C('G'), C('H'), C('J'), C('K'), C('L'), 
NO
,

289 
NO
, NO, NO, 
C
('\\'), C('Z'), C('X'), C('C'), C('V'),

290 
C
('B'), C('N'), C('M'), 
NO
, NO, C('/'), NO, NO,

291 [0x97] = 
KEY_HOME
,

292 [0xB5] = 
C
('/'), [0xC8] = 
KEY_UP
,

293 [0xC9] = 
KEY_PGUP
, [0xCB] = 
KEY_LF
,

294 [0xCD] = 
KEY_RT
, [0xCF] = 
KEY_END
,

295 [0xD0] = 
KEY_DN
, [0xD1] = 
KEY_PGDN
,

296 [0xD2] = 
KEY_INS
, [0xD3] = 
KEY_DEL


299 
uöt8_t
 *
	gch¨code
[4] = {

300 
n‹mÆm≠
,

301 
shi·m≠
,

302 
˘lm≠
,

303 
˘lm≠


311 
	$kbd_¥oc_d©a
()

313 
c
;

314 
uöt8_t
 
d©a
;

315 
uöt32_t
 
shi·
;

317 i‡((
	`öb
(
KBSTATP
Ë& 
KBS_DIB
) == 0)

320 
d©a
 = 
	`öb
(
KBDATAP
);

322 i‡(
d©a
 == 0xE0) {

324 
shi·
 |
E0ESC
;

326 } i‡(
d©a
 & 0x80) {

328 
d©a
 = (
shi·
 & 
E0ESC
 ? data : data & 0x7F);

329 
shi·
 &~(
shi·code
[
d©a
] | 
E0ESC
);

331 } i‡(
shi·
 & 
E0ESC
) {

333 
d©a
 |= 0x80;

334 
shi·
 &~
E0ESC
;

337 
shi·
 |
shi·code
[
d©a
];

338 
shi·
 ^
toggÀcode
[
d©a
];

340 
c
 = 
ch¨code
[
shi·
 & (
CTL
 | 
SHIFT
)][
d©a
];

341 i‡(
shi·
 & 
CAPSLOCK
) {

342 i‡('a' <
c
 && c <= 'z')

343 
c
 += 'A' - 'a';

344 i‡('A' <
c
 && c <= 'Z')

345 
c
 += 'a' - 'A';

350 i‡(!(~
shi·
 & (
CTL
 | 
ALT
)Ë&& 
c
 =
KEY_DEL
) {

351 
	`˝rötf
("Rebooting!\n");

352 
	`outb
(0x92, 0x3);

355  
c
;

356 
	}
}

359 
	$kbd_öå
()

361 
	`c⁄s_öå
(
kbd_¥oc_d©a
);

362 
	}
}

365 
	$kbd_öô
()

367 
	}
}

376 
	#CONSBUFSIZE
 512

	)

379 
uöt8_t
 
	mbuf
[
CONSBUFSIZE
];

380 
uöt32_t
 
	mΩos
;

381 
uöt32_t
 
	mwpos
;

382 } 
	gc⁄s
;

387 
c⁄s_öå
((*
¥oc
)())

389 
c
;

391 (
c
 = (*
¥oc
)()) != -1) {

392 i‡(
c
 == 0)

394 
c⁄s
.
buf
[c⁄s.
wpos
++] = 
c
;

395 i‡(
c⁄s
.
wpos
 =
CONSBUFSIZE
)

396 
c⁄s
.
wpos
 = 0;

398 
	}
}

402 
	$c⁄s_gëc
()

404 
c
;

409 
	`£rül_öå
();

410 
	`kbd_öå
();

413 i‡(
c⁄s
.
Ωos
 !c⁄s.
wpos
) {

414 
c
 = 
c⁄s
.
buf
[c⁄s.
Ωos
++];

415 i‡(
c⁄s
.
Ωos
 =
CONSBUFSIZE
)

416 
c⁄s
.
Ωos
 = 0;

417  
c
;

420 
	}
}

423 
	$c⁄s_putc
(
c
)

425 
	`£rül_putc
(
c
);

426 
	`Õt_putc
(
c
);

427 
	`cga_putc
(
c
);

428 
	}
}

432 
	$c⁄s_öô
()

434 
	`cga_öô
();

435 
	`kbd_öô
();

436 
	`£rül_öô
();

438 i‡(!
£rül_exi°s
)

439 
	`˝rötf
("SerialÖort doesÇotÉxist!\n");

440 
	}
}

445 
	$˝utch¨
(
c
)

447 
	`c⁄s_putc
(
c
);

448 
	}
}

450 
	$gëch¨
()

452 
c
;

454 (
c
 = 
	`c⁄s_gëc
()) == 0)

456  
c
;

457 
	}
}

460 
	$isc⁄s
(
fdnum
)

464 
	}
}

	@kern/console.h

3 #i‚de‡
_CONSOLE_H_


4 
	#_CONSOLE_H_


	)

5 #i‚de‡
JOS_KERNEL


9 
	~<öc/ty≥s.h
>

11 
	#MONO_BASE
 0x3B4

	)

12 
	#MONO_BUF
 0xB0000

	)

13 
	#CGA_BASE
 0x3D4

	)

14 
	#CGA_BUF
 0xB8000

	)

16 
	#CRT_ROWS
 25

	)

17 
	#CRT_COLS
 80

	)

18 
	#CRT_SIZE
 (
CRT_ROWS
 * 
CRT_COLS
)

	)

20 
c⁄s_öô
();

21 
c⁄s_gëc
();

23 
kbd_öå
();

24 
£rül_öå
();

	@kern/init.c

3 
	~<öc/°dio.h
>

4 
	~<öc/°rög.h
>

5 
	~<öc/as£π.h
>

7 
	~<kîn/m⁄ô‹.h
>

8 
	~<kîn/c⁄sﬁe.h
>

11 
	$ã°_backåa˚
(
x
)

13 
	`˝rötf
("íãrögÅe°_backåa˚ %d\n", 
x
);

14 i‡(
x
 > 0)

15 
	`ã°_backåa˚
(
x
-1);

17 
	`m⁄_backåa˚
(0, 0, 0);

18 
	`˝rötf
("ÀavögÅe°_backåa˚ %d\n", 
x
);

19 
	}
}

21 
	$i386_öô
()

23 
ed©a
[], 
íd
[];

28 
	`mem£t
(
ed©a
, 0, 
íd
 -Édata);

32 
	`c⁄s_öô
();

34 
	`˝rötf
("6828 decimal is %o octal!\n", 6828);

43 
	`ã°_backåa˚
(5);

47 
	`m⁄ô‹
(
NULL
);

48 
	}
}

55 c⁄° *
	g∑nic°r
;

61 
	$_∑nic
(c⁄° *
fûe
, 
löe
, c⁄° *
fmt
,...)

63 
va_li°
 
≠
;

65 i‡(
∑nic°r
)

66 
dód
;

67 
∑nic°r
 = 
fmt
;

69 
	`va_°¨t
(
≠
, 
fmt
);

70 
	`˝rötf
("kî√»∑ni¯© %s:%d: ", 
fûe
, 
löe
);

71 
	`v˝rötf
(
fmt
, 
≠
);

72 
	`˝rötf
("\n");

73 
	`va_íd
(
≠
);

75 
dód
:

78 
	`m⁄ô‹
(
NULL
);

79 
	}
}

83 
	$_w¨n
(c⁄° *
fûe
, 
löe
, c⁄° *
fmt
,...)

85 
va_li°
 
≠
;

87 
	`va_°¨t
(
≠
, 
fmt
);

88 
	`˝rötf
("kî√»w¨nögáà%s:%d: ", 
fûe
, 
löe
);

89 
	`v˝rötf
(
fmt
, 
≠
);

90 
	`˝rötf
("\n");

91 
	`va_íd
(
≠
);

92 
	}
}

	@kern/kclock.c

8 
	~<öc/x86.h
>

10 
	~<kîn/k˛ock.h
>

14 
	$mc146818_ªad
(
ªg
)

16 
	`outb
(
IO_RTC
, 
ªg
);

17  
	`öb
(
IO_RTC
+1);

18 
	}
}

21 
	$mc146818_wrôe
(
ªg
, 
d©um
)

23 
	`outb
(
IO_RTC
, 
ªg
);

24 
	`outb
(
IO_RTC
+1, 
d©um
);

25 
	}
}

	@kern/kclock.h

3 #i‚de‡
JOS_KERN_KCLOCK_H


4 
	#JOS_KERN_KCLOCK_H


	)

5 #i‚de‡
JOS_KERNEL


9 
	#IO_RTC
 0x070

	)

11 
	#MC_NVRAM_START
 0xê

	)

12 
	#MC_NVRAM_SIZE
 50

	)

15 
	#NVRAM_BASELO
 (
MC_NVRAM_START
 + 7Ë

	)

16 
	#NVRAM_BASEHI
 (
MC_NVRAM_START
 + 8Ë

	)

19 
	#NVRAM_EXTLO
 (
MC_NVRAM_START
 + 9Ë

	)

20 
	#NVRAM_EXTHI
 (
MC_NVRAM_START
 + 10Ë

	)

23 
	#NVRAM_PEXTLO
 (
MC_NVRAM_START
 + 34Ë

	)

24 
	#NVRAM_PEXTHI
 (
MC_NVRAM_START
 + 35Ë

	)

27 
	#NVRAM_CENTURY
 (
MC_NVRAM_START
 + 36Ë

	)

29 
mc146818_ªad
(
ªg
);

30 
mc146818_wrôe
(
ªg
, 
d©um
);

31 
k˛ock_öô
();

	@kern/kdebug.c

1 
	~<öc/°ab.h
>

2 
	~<öc/°rög.h
>

3 
	~<öc/memœyout.h
>

4 
	~<öc/as£π.h
>

6 
	~<kîn/kdebug.h
>

8 c⁄° 
Sèb
 
__STAB_BEGIN__
[];

9 c⁄° 
Sèb
 
__STAB_END__
[];

10 c⁄° 
__STABSTR_BEGIN__
[];

11 c⁄° 
__STABSTR_END__
[];

51 
	$°ab_bö£¨ch
(c⁄° 
Sèb
 *
°abs
, *
ªgi⁄_À·
, *
ªgi⁄_right
,

52 
ty≥
, 
uöçå_t
 
addr
)

54 
l
 = *
ªgi⁄_À·
, 
r
 = *
ªgi⁄_right
, 
™y_m©ches
 = 0;

56 
l
 <
r
) {

57 
åue_m
 = (
l
 + 
r
Ë/ 2, 
m
 =Årue_m;

60 
m
 >
l
 && 
°abs
[m].
n_ty≥
 !
ty≥
)

61 
m
--;

62 i‡(
m
 < 
l
) {

63 
l
 = 
åue_m
 + 1;

68 
™y_m©ches
 = 1;

69 i‡(
°abs
[
m
].
n_vÆue
 < 
addr
) {

70 *
ªgi⁄_À·
 = 
m
;

71 
l
 = 
åue_m
 + 1;

72 } i‡(
°abs
[
m
].
n_vÆue
 > 
addr
) {

73 *
ªgi⁄_right
 = 
m
 - 1;

74 
r
 = 
m
 - 1;

78 *
ªgi⁄_À·
 = 
m
;

79 
l
 = 
m
;

80 
addr
++;

84 i‡(!
™y_m©ches
)

85 *
ªgi⁄_right
 = *
ªgi⁄_À·
 - 1;

88 
l
 = *
ªgi⁄_right
;

89 
l
 > *
ªgi⁄_À·
 && 
°abs
[l].
n_ty≥
 !
ty≥
;

90 
l
--)

92 *
ªgi⁄_À·
 = 
l
;

94 
	}
}

105 
	$debugöfo_eù
(
uöçå_t
 
addr
, 
Eùdebugöfo
 *
öfo
)

107 c⁄° 
Sèb
 *
°abs
, *
°ab_íd
;

108 c⁄° *
°ab°r
, *
°ab°r_íd
;

109 
lfûe
, 
rfûe
, 
lfun
, 
rfun
, 
Œöe
, 
æöe
;

112 
öfo
->
eù_fûe
 = "<unknown>";

113 
öfo
->
eù_löe
 = 0;

114 
öfo
->
eù_‚_«me
 = "<unknown>";

115 
öfo
->
eù_‚_«mñí
 = 9;

116 
öfo
->
eù_‚_addr
 = 
addr
;

117 
öfo
->
eù_‚_«rg
 = 0;

120 i‡(
addr
 >
ULIM
) {

121 
°abs
 = 
__STAB_BEGIN__
;

122 
°ab_íd
 = 
__STAB_END__
;

123 
°ab°r
 = 
__STABSTR_BEGIN__
;

124 
°ab°r_íd
 = 
__STABSTR_END__
;

127 
	`∑nic
("Useráddress");

131 i‡(
°ab°r_íd
 <
°ab°r
 || stabstr_end[-1] != 0)

140 
lfûe
 = 0;

141 
rfûe
 = (
°ab_íd
 - 
°abs
) - 1;

142 
	`°ab_bö£¨ch
(
°abs
, &
lfûe
, &
rfûe
, 
N_SO
, 
addr
);

143 i‡(
lfûe
 == 0)

148 
lfun
 = 
lfûe
;

149 
rfun
 = 
rfûe
;

150 
	`°ab_bö£¨ch
(
°abs
, &
lfun
, &
rfun
, 
N_FUN
, 
addr
);

152 i‡(
lfun
 <
rfun
) {

155 i‡(
°abs
[
lfun
].
n_°rx
 < 
°ab°r_íd
 - 
°ab°r
)

156 
öfo
->
eù_‚_«me
 = 
°ab°r
 + 
°abs
[
lfun
].
n_°rx
;

157 
öfo
->
eù_‚_addr
 = 
°abs
[
lfun
].
n_vÆue
;

158 
addr
 -
öfo
->
eù_‚_addr
;

160 
Œöe
 = 
lfun
;

161 
æöe
 = 
rfun
;

165 
öfo
->
eù_‚_addr
 = 
addr
;

166 
Œöe
 = 
lfûe
;

167 
æöe
 = 
rfûe
;

170 
öfo
->
eù_‚_«mñí
 = 
	`°rföd
(öfo->
eù_‚_«me
, ':') - info->eip_fn_name;

189 
Œöe
 >
lfûe


190 && 
°abs
[
Œöe
].
n_ty≥
 !
N_SOL


191 && (
°abs
[
Œöe
].
n_ty≥
 !
N_SO
 || !°abs[Œöe].
n_vÆue
))

192 
Œöe
--;

193 i‡(
Œöe
 >
lfûe
 && 
°abs
[Œöe].
n_°rx
 < 
°ab°r_íd
 - 
°ab°r
)

194 
öfo
->
eù_fûe
 = 
°ab°r
 + 
°abs
[
Œöe
].
n_°rx
;

199 i‡(
lfun
 < 
rfun
)

200 
Œöe
 = 
lfun
 + 1;

201 
Œöe
 < 
rfun
 && 
°abs
[Œöe].
n_ty≥
 =
N_PSYM
;

202 
Œöe
++)

203 
öfo
->
eù_‚_«rg
++;

206 
	}
}

	@kern/kdebug.h

1 #i‚de‡
JOS_KERN_KDEBUG_H


2 
	#JOS_KERN_KDEBUG_H


	)

4 
	~<öc/ty≥s.h
>

7 
	sEùdebugöfo
 {

8 c⁄° *
	meù_fûe
;

9 
	meù_löe
;

11 c⁄° *
	meù_‚_«me
;

13 
	meù_‚_«mñí
;

14 
uöçå_t
 
	meù_‚_addr
;

15 
	meù_‚_«rg
;

18 
debugöfo_eù
(
uöçå_t
 
eù
, 
Eùdebugöfo
 *
öfo
);

	@kern/monitor.c

4 
	~<öc/°dio.h
>

5 
	~<öc/°rög.h
>

6 
	~<öc/memœyout.h
>

7 
	~<öc/as£π.h
>

8 
	~<öc/x86.h
>

9 
	~<öc/ty≥s.h
>

11 
	~<kîn/c⁄sﬁe.h
>

12 
	~<kîn/m⁄ô‹.h
>

13 
	~<kîn/kdebug.h
>

15 
	#CMDBUF_SIZE
 80

16 

	)

18 
	sComm™d
 {

19 c⁄° *
	m«me
;

20 c⁄° *
	mdesc
;

22 (*
	mfunc
)(
	m¨gc
, ** 
	m¨gv
, 
Tøp‰ame
* 
	mtf
);

25 
Comm™d
 
	gcomm™ds
[] = {

26 { "hñp", "Di•œyÅhi†li° o‡comm™ds", 
m⁄_hñp
 },

27 { "kînöfo", "Di•œy inf‹m©i⁄ábouàthêkî√l", 
m⁄_kînöfo
 },

28 {"backåa˚", "Di•œy inf‹m©i⁄ábouàthê°ack", 
m⁄_backåa˚
},

30 
	#NCOMMANDS
 ((
comm™ds
)/(comm™ds[0]))

	)

32 
ªad_eù
();

37 
	$m⁄_hñp
(
¨gc
, **
¨gv
, 
Tøp‰ame
 *
tf
)

39 
i
;

41 
i
 = 0; i < 
NCOMMANDS
; i++)

42 
	`˝rötf
("%†- %s\n", 
comm™ds
[
i
].
«me
, comm™ds[i].
desc
);

44 
	}
}

47 
	$m⁄_kînöfo
(
¨gc
, **
¨gv
, 
Tøp‰ame
 *
tf
)

49 
_°¨t
[], 
ëext
[], 
ed©a
[], 
íd
[];

51 
	`˝rötf
("Special kernel symbols:\n");

52 
	`˝rötf
(" _°¨à%08x (vútË %08x (phys)\n", 
_°¨t
, _°¨à- 
KERNBASE
);

53 
	`˝rötf
("Éãxà %08x (vútË %08x (phys)\n", 
ëext
,Éãxà- 
KERNBASE
);

54 
	`˝rötf
("Éd©® %08x (vútË %08x (phys)\n", 
ed©a
,Éd©®- 
KERNBASE
);

55 
	`˝rötf
("Énd %08x (vútË %08x (phys)\n", 
íd
,Énd - 
KERNBASE
);

56 
	`˝rötf
("KernelÉxecutable memory footprint: %dKB\n",

57 (
íd
-
_°¨t
+1023)/1024);

59 
	}
}

62 
	$m⁄_backåa˚
(
¨gc
, **
¨gv
, 
Tøp‰ame
 *
tf
)

65 
uöt32_t
 
ebp_addr
 = 
	`ªad_ebp
();

66 
uöt32_t
 
eù_addr
 = *((uöt32_t*)(
ebp_addr
 + 1));

67 
uöt32_t
 
¨g1
 = *((uöt32_t*)(
ebp_addr
 + 2));

68 
uöt32_t
 
¨g2
 = *((uöt32_t*)(
ebp_addr
 + 3));

69 
uöt32_t
 
¨g3
 = *((uöt32_t*)(
ebp_addr
 + 4));

73 
	`˝rötf
("eb∞%xÉù %xárg %x %x %x \n", 
ebp_addr
, 
eù_addr
, 
¨g1
, 
¨g2
, 
¨g3
);

74 
ebp_addr
 = *((
uöt32_t
*)(ebp_addr));

75 if–
ebp_addr
 != 0)

77 
uöt32_t
 
eù_addr
 = *((uöt32_t*)(
ebp_addr
 + 1));

78 
uöt32_t
 
¨g1
 = *((uöt32_t*)(
ebp_addr
 + 2));

79 
uöt32_t
 
¨g2
 = *((uöt32_t*)(
ebp_addr
 + 3));

80 
uöt32_t
 
¨g3
 = *((uöt32_t*)(
ebp_addr
 + 4));

82 }
ebp_addr
 != 0);

85 
	}
}

91 
	#WHITESPACE
 "\t\r\¿"

	)

92 
	#MAXARGS
 16

	)

95 
	$runcmd
(*
buf
, 
Tøp‰ame
 *
tf
)

97 
¨gc
;

98 *
¨gv
[
MAXARGS
];

99 
i
;

102 
¨gc
 = 0;

103 
¨gv
[
¨gc
] = 0;

106 *
buf
 && 
	`°rchr
(
WHITESPACE
, *buf))

107 *
buf
++ = 0;

108 i‡(*
buf
 == 0)

112 i‡(
¨gc
 =
MAXARGS
-1) {

113 
	`˝rötf
("Toÿm™yárgumít†(max %d)\n", 
MAXARGS
);

116 
¨gv
[
¨gc
++] = 
buf
;

117 *
buf
 && !
	`°rchr
(
WHITESPACE
, *buf))

118 
buf
++;

120 
¨gv
[
¨gc
] = 0;

123 i‡(
¨gc
 == 0)

125 
i
 = 0; i < 
NCOMMANDS
; i++) {

126 i‡(
	`°rcmp
(
¨gv
[0], 
comm™ds
[
i
].
«me
) == 0)

127  
comm™ds
[
i
].
	`func
(
¨gc
, 
¨gv
, 
tf
);

129 
	`˝rötf
("Unknow¿comm™d '%s'\n", 
¨gv
[0]);

131 
	}
}

133 
	$m⁄ô‹
(
Tøp‰ame
 *
tf
)

135 *
buf
;

137 
	`˝rötf
("WelcomeÅoÅhe JOS kernel monitor!\n");

138 
	`˝rötf
("Type 'help' foráÜist of commands.\n");

142 
buf
 = 
	`ªadlöe
("K> ");

143 i‡(
buf
 !
NULL
)

144 i‡(
	`runcmd
(
buf
, 
tf
) < 0)

147 
	}
}

153 
	$ªad_eù
()

155 
uöt32_t
 
ˇŒîpc
;

156 
__asm
 
	`__vﬁ©ûe
("mov»4(%%ebp), %0" : "Ù" (
ˇŒîpc
));

157  
ˇŒîpc
;

158 
	}
}

	@kern/monitor.h

1 #i‚de‡
JOS_KERN_MONITOR_H


2 
	#JOS_KERN_MONITOR_H


	)

3 #i‚de‡
JOS_KERNEL


7 
	gTøp‰ame
;

12 
m⁄ô‹
(
Tøp‰ame
 *
tf
);

15 
m⁄_hñp
(
¨gc
, **
¨gv
, 
Tøp‰ame
 *
tf
);

16 
m⁄_kînöfo
(
¨gc
, **
¨gv
, 
Tøp‰ame
 *
tf
);

17 
m⁄_backåa˚
(
¨gc
, **
¨gv
, 
Tøp‰ame
 *
tf
);

	@kern/pmap.c

3 
	~<öc/x86.h
>

4 
	~<öc/mmu.h
>

5 
	~<öc/îr‹.h
>

6 
	~<öc/°rög.h
>

7 
	~<öc/as£π.h
>

9 
	~<kîn/pm≠.h
>

10 
	~<kîn/k˛ock.h
>

13 
phyßddr_t
 
	gmax∑
;

14 
size_t
 
	g≈age
;

15 
size_t
 
	gba£mem
;

16 
size_t
 
	gextmem
;

19 
pde_t
* 
	gboŸ_pgdú
;

20 
phyßddr_t
 
	gboŸ_¸3
;

21 * 
	gboŸ_‰ìmem
;

23 
Page
* 
	g∑ges
;

24 
Page_li°
 
	g∑ge_‰ì_li°
;

32 
Segdesc
 
	ggdt
[] =

35 
SEG_NULL
,

38 [
GD_KT
 >> 3] = 
SEG
(
STA_X
 | 
STA_R
, 0x0, 0xffffffff, 0),

41 [
GD_KD
 >> 3] = 
SEG
(
STA_W
, 0x0, 0xffffffff, 0),

44 [
GD_UT
 >> 3] = 
SEG
(
STA_X
 | 
STA_R
, 0x0, 0xffffffff, 3),

47 [
GD_UD
 >> 3] = 
SEG
(
STA_W
, 0x0, 0xffffffff, 3),

50 [
GD_TSS
 >> 3] = 
SEG_NULL


53 
P£udodesc
 
	ggdt_pd
 = {

54 (
gdt
) - 1, () gdt

58 
	$nvøm_ªad
(
r
)

60  
	`mc146818_ªad
(
r
) | (mc146818_read(r + 1) << 8);

61 
	}
}

64 
	$i386_dëe˘_mem‹y
()

67 
ba£mem
 = 
	`ROUNDDOWN
(
	`nvøm_ªad
(
NVRAM_BASELO
)*1024, 
PGSIZE
);

68 
extmem
 = 
	`ROUNDDOWN
(
	`nvøm_ªad
(
NVRAM_EXTLO
)*1024, 
PGSIZE
);

72 i‡(
extmem
)

73 
max∑
 = 
EXTPHYSMEM
 + 
extmem
;

75 
max∑
 = 
ba£mem
;

77 
≈age
 = 
max∑
 / 
PGSIZE
;

79 
	`˝rötf
("Physiˇ»mem‹y: %dKávaûabÀ, ", ()(
max∑
/1024));

80 
	`˝rötf
("ba£ = %dK,Éxãnded = %dK\n", ()(
ba£mem
/1024), ()(
extmem
/1024));

81 
	}
}

87 
check_boŸ_pgdú
();

88 
check_∑ge_Æloc
();

89 
∑ge_check
();

90 
boŸ_m≠_£gmít
(
pde_t
 *
pgdú
, 
uöçå_t
 
œ
, 
size_t
 
size
, 
phyßddr_t
 
∑
, 
≥rm
);

106 
	$boŸ_Æloc
(
uöt32_t
 
n
, uöt32_à
Æign
)

108 
íd
[];

109 *
v
;

116 i‡(
boŸ_‰ìmem
 == 0)

117 
boŸ_‰ìmem
 = 
íd
;

126  
NULL
;

127 
	}
}

142 
	$i386_vm_öô
()

144 
pde_t
* 
pgdú
;

145 
uöt32_t
 
¸0
;

146 
size_t
 
n
;

149 
	`∑nic
("i386_vm_init: This function isÇot finished\n");

153 
pgdú
 = 
	`boŸ_Æloc
(
PGSIZE
, PGSIZE);

154 
	`mem£t
(
pgdú
, 0, 
PGSIZE
);

155 
boŸ_pgdú
 = 
pgdú
;

156 
boŸ_¸3
 = 
	`PADDR
(
pgdú
);

165 
pgdú
[
	`PDX
(
VPT
)] = 
	`PADDR
’gdú)|
PTE_W
|
PTE_P
;

169 
pgdú
[
	`PDX
(
UVPT
)] = 
	`PADDR
’gdú)|
PTE_U
|
PTE_P
;

185 
	`∑ge_öô
();

187 
	`check_∑ge_Æloc
();

189 
	`∑ge_check
();

224 
	`check_boŸ_pgdú
();

242 
pgdú
[0] =Ögdú[
	`PDX
(
KERNBASE
)];

245 
	`l¸3
(
boŸ_¸3
);

248 
¸0
 = 
	`r¸0
();

249 
¸0
 |
CR0_PE
|
CR0_PG
|
CR0_AM
|
CR0_WP
|
CR0_NE
|
CR0_TS
|
CR0_EM
|
CR0_MP
;

250 
¸0
 &~(
CR0_TS
|
CR0_EM
);

251 
	`l¸0
(
¸0
);

257 
asm
 volatile("lgdt gdt_pd");

258 
asm
 vﬁ©ûe("movw %%ax,%%gs" :: "a" (
GD_UD
|3));

259 
asm
 vﬁ©ûe("movw %%ax,%%fs" :: "a" (
GD_UD
|3));

260 
asm
 vﬁ©ûe("movw %%ax,%%es" :: "a" (
GD_KD
));

261 
asm
 vﬁ©ûe("movw %%ax,%%ds" :: "a" (
GD_KD
));

262 
asm
 vﬁ©ûe("movw %%ax,%%ss" :: "a" (
GD_KD
));

263 
asm
 vﬁ©ûe("ljm∞%0,$1f\¿1:\n" :: "i" (
GD_KT
));

264 
asm
 volatile("lldt %%ax" :: "a" (0));

270 
pgdú
[0] = 0;

273 
	`l¸3
(
boŸ_¸3
);

274 
	}
}

281 
	$check_∑ge_Æloc
()

283 
Page
 *
µ
, *
µ0
, *
µ1
, *
µ2
;

284 
Page_li°
 
Ê
;

289 
	`LIST_FOREACH
(
µ0
, &
∑ge_‰ì_li°
, 
µ_lök
)

290 
	`mem£t
(
	`∑ge2kva
(
µ0
), 0x97, 128);

292 
	`LIST_FOREACH
(
µ0
, &
∑ge_‰ì_li°
, 
µ_lök
) {

294 
	`as£π
(
µ0
 >
∑ges
);

295 
	`as£π
(
µ0
 < 
∑ges
 + 
≈age
);

298 
	`as£π
(
	`∑ge2∑
(
µ0
) != 0);

299 
	`as£π
(
	`∑ge2∑
(
µ0
Ë!
IOPHYSMEM
);

300 
	`as£π
(
	`∑ge2∑
(
µ0
Ë!
EXTPHYSMEM
 - 
PGSIZE
);

301 
	`as£π
(
	`∑ge2∑
(
µ0
Ë!
EXTPHYSMEM
);

302 
	`as£π
(
	`∑ge2kva
(
µ0
Ë!
	`ROUNDDOWN
(
boŸ_‰ìmem
 - 1, 
PGSIZE
));

306 
µ0
 = 
µ1
 = 
µ2
 = 0;

307 
	`as£π
(
	`∑ge_Æloc
(&
µ0
) == 0);

308 
	`as£π
(
	`∑ge_Æloc
(&
µ1
) == 0);

309 
	`as£π
(
	`∑ge_Æloc
(&
µ2
) == 0);

311 
	`as£π
(
µ0
);

312 
	`as£π
(
µ1
 &&Öp1 !
µ0
);

313 
	`as£π
(
µ2
 &&Öp2 !
µ1
 &&Öp2 !
µ0
);

314 
	`as£π
(
	`∑ge2∑
(
µ0
Ë< 
≈age
*
PGSIZE
);

315 
	`as£π
(
	`∑ge2∑
(
µ1
Ë< 
≈age
*
PGSIZE
);

316 
	`as£π
(
	`∑ge2∑
(
µ2
Ë< 
≈age
*
PGSIZE
);

319 
Ê
 = 
∑ge_‰ì_li°
;

320 
	`LIST_INIT
(&
∑ge_‰ì_li°
);

323 
	`as£π
(
	`∑ge_Æloc
(&
µ
Ë=-
E_NO_MEM
);

326 
	`∑ge_‰ì
(
µ0
);

327 
	`∑ge_‰ì
(
µ1
);

328 
	`∑ge_‰ì
(
µ2
);

329 
µ0
 = 
µ1
 = 
µ2
 = 0;

330 
	`as£π
(
	`∑ge_Æloc
(&
µ0
) == 0);

331 
	`as£π
(
	`∑ge_Æloc
(&
µ1
) == 0);

332 
	`as£π
(
	`∑ge_Æloc
(&
µ2
) == 0);

333 
	`as£π
(
µ0
);

334 
	`as£π
(
µ1
 &&Öp1 !
µ0
);

335 
	`as£π
(
µ2
 &&Öp2 !
µ1
 &&Öp2 !
µ0
);

336 
	`as£π
(
	`∑ge_Æloc
(&
µ
Ë=-
E_NO_MEM
);

339 
∑ge_‰ì_li°
 = 
Ê
;

342 
	`∑ge_‰ì
(
µ0
);

343 
	`∑ge_‰ì
(
µ1
);

344 
	`∑ge_‰ì
(
µ2
);

346 
	`˝rötf
("check_page_alloc() succeeded!\n");

347 
	}
}

357 
phyßddr_t
 
check_va2∑
(
pde_t
 *
pgdú
, 
uöçå_t
 
va
);

360 
	$check_boŸ_pgdú
()

362 
uöt32_t
 
i
, 
n
;

363 
pde_t
 *
pgdú
;

365 
pgdú
 = 
boŸ_pgdú
;

368 
n
 = 
	`ROUNDUP
(
≈age
*(
Page
), 
PGSIZE
);

369 
i
 = 0; i < 
n
; i +
PGSIZE
)

370 
	`as£π
(
	`check_va2∑
(
pgdú
, 
UPAGES
 + 
i
Ë=
	`PADDR
(
∑ges
) + i);

374 
i
 = 0; i < 
≈age
 * 
PGSIZE
; i += PGSIZE)

375 
	`as£π
(
	`check_va2∑
(
pgdú
, 
KERNBASE
 + 
i
) == i);

378 
i
 = 0; i < 
KSTKSIZE
; i +
PGSIZE
)

379 
	`as£π
(
	`check_va2∑
(
pgdú
, 
KSTACKTOP
 - 
KSTKSIZE
 + 
i
Ë=
	`PADDR
(
boŸ°ack
) + i);

380 
	`as£π
(
	`check_va2∑
(
pgdú
, 
KSTACKTOP
 - 
PTSIZE
) == ~0);

383 
i
 = 0; i < 
NPDENTRIES
; i++) {

384 
i
) {

385 
	`PDX
(
VPT
):

386 
	`PDX
(
UVPT
):

387 
	`PDX
(
KSTACKTOP
-1):

388 
	`PDX
(
UPAGES
):

389 
	`as£π
(
pgdú
[
i
]);

392 i‡(
i
 >
	`PDX
(
KERNBASE
))

393 
	`as£π
(
pgdú
[
i
]);

395 
	`as£π
(
pgdú
[
i
] == 0);

399 
	`˝rötf
("check_boot_pgdir() succeeded!\n");

400 
	}
}

407 
phyßddr_t


408 
	$check_va2∑
(
pde_t
 *
pgdú
, 
uöçå_t
 
va
)

410 
±e_t
 *
p
;

412 
pgdú
 = &pgdú[
	`PDX
(
va
)];

413 i‡(!(*
pgdú
 & 
PTE_P
))

415 
p
 = (
±e_t
*Ë
	`KADDR
(
	`PTE_ADDR
(*
pgdú
));

416 i‡(!(
p
[
	`PTX
(
va
)] & 
PTE_P
))

418  
	`PTE_ADDR
(
p
[
	`PTX
(
va
)]);

419 
	}
}

434 
	$∑ge_öô
()

450 
i
;

451 
	`LIST_INIT
(&
∑ge_‰ì_li°
);

452 
i
 = 0; i < 
≈age
; i++) {

453 
∑ges
[
i
].
µ_ªf
 = 0;

454 
	`LIST_INSERT_HEAD
(&
∑ge_‰ì_li°
, &
∑ges
[
i
], 
µ_lök
);

456 
	}
}

464 
	$∑ge_öôµ
(
Page
 *
µ
)

466 
	`mem£t
(
µ
, 0, (*pp));

467 
	}
}

484 
	$∑ge_Æloc
(
Page
 **
µ_°‹e
)

487  -
E_NO_MEM
;

488 
	}
}

495 
	$∑ge_‰ì
(
Page
 *
µ
)

498 
	}
}

505 
	$∑ge_de¸ef
(
Page
* 
µ
)

507 i‡(--
µ
->
µ_ªf
 == 0)

508 
	`∑ge_‰ì
(
µ
);

509 
	}
}

529 
±e_t
 *

530 
	$pgdú_wÆk
(
pde_t
 *
pgdú
, c⁄° *
va
, 
¸óã
)

533  
NULL
;

534 
	}
}

559 
	$∑ge_ö£π
(
pde_t
 *
pgdú
, 
Page
 *
µ
, *
va
, 
≥rm
)

563 
	}
}

576 
	$boŸ_m≠_£gmít
(
pde_t
 *
pgdú
, 
uöçå_t
 
œ
, 
size_t
 
size
, 
phyßddr_t
 
∑
, 
≥rm
)

579 
	}
}

592 
Page
 *

593 
	$∑ge_lookup
(
pde_t
 *
pgdú
, *
va
, 
±e_t
 **
±e_°‹e
)

596  
NULL
;

597 
	}
}

615 
	$∑ge_ªmove
(
pde_t
 *
pgdú
, *
va
)

618 
	}
}

625 
	$éb_övÆid©e
(
pde_t
 *
pgdú
, *
va
)

629 
	`övÕg
(
va
);

630 
	}
}

634 
	$∑ge_check
()

636 
Page
 *
µ
, *
µ0
, *
µ1
, *
µ2
;

637 
Page_li°
 
Ê
;

638 
±e_t
 *
±ï
, *
±ï1
;

639 *
va
;

640 
i
;

643 
µ0
 = 
µ1
 = 
µ2
 = 0;

644 
	`as£π
(
	`∑ge_Æloc
(&
µ0
) == 0);

645 
	`as£π
(
	`∑ge_Æloc
(&
µ1
) == 0);

646 
	`as£π
(
	`∑ge_Æloc
(&
µ2
) == 0);

648 
	`as£π
(
µ0
);

649 
	`as£π
(
µ1
 &&Öp1 !
µ0
);

650 
	`as£π
(
µ2
 &&Öp2 !
µ1
 &&Öp2 !
µ0
);

653 
Ê
 = 
∑ge_‰ì_li°
;

654 
	`LIST_INIT
(&
∑ge_‰ì_li°
);

657 
	`as£π
(
	`∑ge_Æloc
(&
µ
Ë=-
E_NO_MEM
);

660 
	`as£π
(
	`∑ge_lookup
(
boŸ_pgdú
, (*Ë0x0, &
±ï
Ë=
NULL
);

663 
	`as£π
(
	`∑ge_ö£π
(
boŸ_pgdú
, 
µ1
, 0x0, 0) < 0);

666 
	`∑ge_‰ì
(
µ0
);

667 
	`as£π
(
	`∑ge_ö£π
(
boŸ_pgdú
, 
µ1
, 0x0, 0) == 0);

668 
	`as£π
(
	`PTE_ADDR
(
boŸ_pgdú
[0]Ë=
	`∑ge2∑
(
µ0
));

669 
	`as£π
(
	`check_va2∑
(
boŸ_pgdú
, 0x0Ë=
	`∑ge2∑
(
µ1
));

670 
	`as£π
(
µ1
->
µ_ªf
 == 1);

671 
	`as£π
(
µ0
->
µ_ªf
 == 1);

674 
	`as£π
(
	`∑ge_ö£π
(
boŸ_pgdú
, 
µ2
, (*Ë
PGSIZE
, 0) == 0);

675 
	`as£π
(
	`check_va2∑
(
boŸ_pgdú
, 
PGSIZE
Ë=
	`∑ge2∑
(
µ2
));

676 
	`as£π
(
µ2
->
µ_ªf
 == 1);

679 
	`as£π
(
	`∑ge_Æloc
(&
µ
Ë=-
E_NO_MEM
);

682 
	`as£π
(
	`∑ge_ö£π
(
boŸ_pgdú
, 
µ2
, (*Ë
PGSIZE
, 0) == 0);

683 
	`as£π
(
	`check_va2∑
(
boŸ_pgdú
, 
PGSIZE
Ë=
	`∑ge2∑
(
µ2
));

684 
	`as£π
(
µ2
->
µ_ªf
 == 1);

688 
	`as£π
(
	`∑ge_Æloc
(&
µ
Ë=-
E_NO_MEM
);

691 
±ï
 = 
	`KADDR
(
	`PTE_ADDR
(
boŸ_pgdú
[
	`PDX
(
PGSIZE
)]));

692 
	`as£π
(
	`pgdú_wÆk
(
boŸ_pgdú
, (*)
PGSIZE
, 0Ë=
±ï
+
	`PTX
(PGSIZE));

695 
	`as£π
(
	`∑ge_ö£π
(
boŸ_pgdú
, 
µ2
, (*Ë
PGSIZE
, 
PTE_U
) == 0);

696 
	`as£π
(
	`check_va2∑
(
boŸ_pgdú
, 
PGSIZE
Ë=
	`∑ge2∑
(
µ2
));

697 
	`as£π
(
µ2
->
µ_ªf
 == 1);

698 
	`as£π
(*
	`pgdú_wÆk
(
boŸ_pgdú
, (*Ë
PGSIZE
, 0Ë& 
PTE_U
);

699 
	`as£π
(
boŸ_pgdú
[0] & 
PTE_U
);

702 
	`as£π
(
	`∑ge_ö£π
(
boŸ_pgdú
, 
µ0
, (*Ë
PTSIZE
, 0) < 0);

705 
	`as£π
(
	`∑ge_ö£π
(
boŸ_pgdú
, 
µ1
, (*Ë
PGSIZE
, 0) == 0);

706 
	`as£π
(!(*
	`pgdú_wÆk
(
boŸ_pgdú
, (*Ë
PGSIZE
, 0Ë& 
PTE_U
));

709 
	`as£π
(
	`check_va2∑
(
boŸ_pgdú
, 0Ë=
	`∑ge2∑
(
µ1
));

710 
	`as£π
(
	`check_va2∑
(
boŸ_pgdú
, 
PGSIZE
Ë=
	`∑ge2∑
(
µ1
));

712 
	`as£π
(
µ1
->
µ_ªf
 == 2);

713 
	`as£π
(
µ2
->
µ_ªf
 == 0);

716 
	`as£π
(
	`∑ge_Æloc
(&
µ
Ë=0 &&Ö∞=
µ2
);

719 
	`∑ge_ªmove
(
boŸ_pgdú
, 0x0);

720 
	`as£π
(
	`check_va2∑
(
boŸ_pgdú
, 0x0) == ~0);

721 
	`as£π
(
	`check_va2∑
(
boŸ_pgdú
, 
PGSIZE
Ë=
	`∑ge2∑
(
µ1
));

722 
	`as£π
(
µ1
->
µ_ªf
 == 1);

723 
	`as£π
(
µ2
->
µ_ªf
 == 0);

726 
	`∑ge_ªmove
(
boŸ_pgdú
, (*Ë
PGSIZE
);

727 
	`as£π
(
	`check_va2∑
(
boŸ_pgdú
, 0x0) == ~0);

728 
	`as£π
(
	`check_va2∑
(
boŸ_pgdú
, 
PGSIZE
) == ~0);

729 
	`as£π
(
µ1
->
µ_ªf
 == 0);

730 
	`as£π
(
µ2
->
µ_ªf
 == 0);

733 
	`as£π
(
	`∑ge_Æloc
(&
µ
Ë=0 &&Ö∞=
µ1
);

736 
	`as£π
(
	`∑ge_Æloc
(&
µ
Ë=-
E_NO_MEM
);

741 
	`mem£t
(
	`∑ge2kva
(
µ1
), 1, 
PGSIZE
);

742 
	`mem£t
(
	`∑ge2kva
(
µ2
), 2, 
PGSIZE
);

743 
	`∑ge_ö£π
(
boŸ_pgdú
, 
µ1
, 0x0, 0);

744 
	`as£π
(
µ1
->
µ_ªf
 == 1);

745 
	`as£π
(*(*)0 == 0x01010101);

746 
	`∑ge_ö£π
(
boŸ_pgdú
, 
µ2
, 0x0, 0);

747 
	`as£π
(*(*)0 == 0x02020202);

748 
	`as£π
(
µ2
->
µ_ªf
 == 1);

749 
	`as£π
(
µ1
->
µ_ªf
 == 0);

750 
	`∑ge_ªmove
(
boŸ_pgdú
, 0x0);

751 
	`as£π
(
µ2
->
µ_ªf
 == 0);

755 
	`as£π
(
	`PTE_ADDR
(
boŸ_pgdú
[0]Ë=
	`∑ge2∑
(
µ0
));

756 
boŸ_pgdú
[0] = 0;

757 
	`as£π
(
µ0
->
µ_ªf
 == 1);

758 
µ0
->
µ_ªf
 = 0;

761 
	`∑ge_‰ì
(
µ0
);

762 
va
 = (*)(
PGSIZE
 * 
NPDENTRIES
 + PGSIZE);

763 
±ï
 = 
	`pgdú_wÆk
(
boŸ_pgdú
, 
va
, 1);

764 
±ï1
 = 
	`KADDR
(
	`PTE_ADDR
(
boŸ_pgdú
[
	`PDX
(
va
)]));

765 
	`as£π
(
±ï
 =
±ï1
 + 
	`PTX
(
va
));

766 
boŸ_pgdú
[
	`PDX
(
va
)] = 0;

767 
µ0
->
µ_ªf
 = 0;

770 
	`mem£t
(
	`∑ge2kva
(
µ0
), 0xFF, 
PGSIZE
);

771 
	`∑ge_‰ì
(
µ0
);

772 
	`pgdú_wÆk
(
boŸ_pgdú
, 0x0, 1);

773 
±ï
 = 
	`∑ge2kva
(
µ0
);

774 
i
=0; i<
NPTENTRIES
; i++)

775 
	`as£π
((
±ï
[
i
] & 
PTE_P
) == 0);

776 
boŸ_pgdú
[0] = 0;

777 
µ0
->
µ_ªf
 = 0;

780 
∑ge_‰ì_li°
 = 
Ê
;

783 
	`∑ge_‰ì
(
µ0
);

784 
	`∑ge_‰ì
(
µ1
);

785 
	`∑ge_‰ì
(
µ2
);

787 
	`˝rötf
("page_check() succeeded!\n");

788 
	}
}

	@kern/pmap.h

3 #i‚de‡
JOS_KERN_PMAP_H


4 
	#JOS_KERN_PMAP_H


	)

5 #i‚de‡
JOS_KERNEL


9 
	~<öc/memœyout.h
>

10 
	~<öc/as£π.h
>

18 
	#PADDR
(
kva
) \

20 
phyßddr_t
 
__m_kva
 = (phyßddr_tË(
kva
); \

21 i‡(
__m_kva
 < 
KERNBASE
) \

22 
	`∑nic
("PADDR cÆÀd wôh invÆid kv®%08lx", 
__m_kva
);\

23 
__m_kva
 - 
KERNBASE
; \

24 })

	)

28 
	#KADDR
(
∑
) \

30 
phyßddr_t
 
__m_∑
 = (
∑
); \

31 
uöt32_t
 
__m_µn
 = 
	`PPN
(
__m_∑
); \

32 i‡(
__m_µn
 >
≈age
) \

33 
	`∑nic
("KADDR cÆÀd wôh invÆidÖ®%08lx", 
__m_∑
);\

34 (*Ë(
__m_∑
 + 
KERNBASE
); \

35 })

	)

39 
boŸ°ackt›
[], 
boŸ°ack
[];

41 
Page
 *
∑ges
;

42 
size_t
 
≈age
;

44 
phyßddr_t
 
boŸ_¸3
;

45 
pde_t
 *
boŸ_pgdú
;

47 
Segdesc
 
gdt
[];

48 
P£udodesc
 
gdt_pd
;

50 
i386_vm_öô
();

51 
i386_dëe˘_mem‹y
();

53 
∑ge_öô
();

54 
∑ge_Æloc
(
Page
 **
µ_°‹e
);

55 
∑ge_‰ì
(
Page
 *
µ
);

56 
∑ge_ö£π
(
pde_t
 *
pgdú
, 
Page
 *
µ
, *
va
, 
≥rm
);

57 
∑ge_ªmove
(
pde_t
 *
pgdú
, *
va
);

58 
Page
 *
∑ge_lookup
(
pde_t
 *
pgdú
, *
va
, 
±e_t
 **
±e_°‹e
);

59 
∑ge_de¸ef
(
Page
 *
µ
);

61 
éb_övÆid©e
(
pde_t
 *
pgdú
, *
va
);

63 
ölöe
 
µn_t


64 
	$∑ge2µn
(
Page
 *
µ
)

66  
µ
 - 
∑ges
;

67 
	}
}

69 
ölöe
 
phyßddr_t


70 
	$∑ge2∑
(
Page
 *
µ
)

72  
	`∑ge2µn
(
µ
Ë<< 
PGSHIFT
;

73 
	}
}

75 
ölöe
 
Page
*

76 
	$∑2∑ge
(
phyßddr_t
 
∑
)

78 i‡(
	`PPN
(
∑
Ë>
≈age
)

79 
	`∑nic
("pa2page called with invalidÖa");

80  &
∑ges
[
	`PPN
(
∑
)];

81 
	}
}

83 
ölöe
 *

84 
	$∑ge2kva
(
Page
 *
µ
)

86  
	`KADDR
(
	`∑ge2∑
(
µ
));

87 
	}
}

89 
±e_t
 *
pgdú_wÆk
(
pde_t
 *
pgdú
, c⁄° *
va
, 
¸óã
);

	@kern/printf.c

4 
	~<öc/ty≥s.h
>

5 
	~<öc/°dio.h
>

6 
	~<öc/°d¨g.h
>

9 
	$putch
(
ch
, *
˙t
)

11 
	`˝utch¨
(
ch
);

12 *
˙t
++;

13 
	}
}

15 
	$v˝rötf
(c⁄° *
fmt
, 
va_li°
 
≠
)

17 
˙t
 = 0;

19 
	`v¥ötfmt
((*)
putch
, &
˙t
, 
fmt
, 
≠
);

20  
˙t
;

21 
	}
}

23 
	$˝rötf
(c⁄° *
fmt
, ...)

25 
va_li°
 
≠
;

26 
˙t
;

28 
	`va_°¨t
(
≠
, 
fmt
);

29 
˙t
 = 
	`v˝rötf
(
fmt
, 
≠
);

30 
	`va_íd
(
≠
);

32  
˙t
;

33 
	}
}

	@lib/nsipc.c

1 
	~<öc/ns.h
>

2 
	~<öc/lib.h
>

3 
	~<lwù/sockës.h
>

5 
	#debug
 0

	)

8 
	#REQVA
 0x0ffff000

	)

9 
uöt8_t
 
nsùcbuf
[
PGSIZE
];

19 
	$nsùc
(
ty≥
, *
f§eq
, *
d°va
, *
≥rm
)

21 
ívid_t
 
whom
;

23 i‡(
debug
)

24 
	`˝rötf
("[%08x]Çsù¯%d %08x\n", 
ív
->
ív_id
, 
ty≥
, 
nsùcbuf
);

26 
	`ùc_£nd
(
ívs
[2].
ív_id
, 
ty≥
, 
f§eq
, 
PTE_P
|
PTE_W
|
PTE_U
);

27  
	`ùc_ªcv
(&
whom
, 
d°va
, 
≥rm
);

28 
	}
}

31 
	$nsùc_ac˚±
(
s
, 
sockaddr
 *
addr
, 
sockÀn_t
 *
addæí
)

33 
≥rm
, 
r
;

34 
N§eq_ac˚±
 *
ªq
;

35 
N§ë_ac˚±
 *
ªt
;

37 
ªq
 = (
N§eq_ac˚±
*)
nsùcbuf
;

38 
ªq
->
ªq_s
 = 
s
;

40 
r
 = 
	`nsùc
(
NSREQ_ACCEPT
, 
ªq
, (*)
REQVA
, &
≥rm
);

42 
ªt
 = (
N§ë_ac˚±
*Ë
REQVA
;

43 
	`memmove
(
addr
, &
ªt
->
ªt_addr
,Ñë->
ªt_addæí
);

44 *
addæí
 = 
ªt
->
ªt_addæí
;

46  
r
;

47 
	}
}

50 
	$nsùc_böd
(
s
, 
sockaddr
 *
«me
, 
sockÀn_t
 
«mñí
)

52 
≥rm
;

53 
N§eq_böd
 *
ªq
;

55 
ªq
 = (
N§eq_böd
*)
nsùcbuf
;

56 
ªq
->
ªq_s
 = 
s
;

57 
	`memmove
(&
ªq
->
ªq_«me
, 
«me
, 
«mñí
);

58 
ªq
->
ªq_«mñí
 = 
«mñí
;

59  
	`nsùc
(
NSREQ_BIND
, 
ªq
, 0, &
≥rm
);

60 
	}
}

63 
	$nsùc_shutdown
(
s
, 
how
)

65 
≥rm
;

66 
N§eq_shutdown
 *
ªq
;

68 
ªq
 = (
N§eq_shutdown
*)
nsùcbuf
;

69 
ªq
->
ªq_s
 = 
s
;

70 
ªq
->
ªq_how
 = 
how
;

71  
	`nsùc
(
NSREQ_SHUTDOWN
, 
ªq
, 0, &
≥rm
);

72 
	}
}

75 
	$nsùc_˛o£
(
s
)

77 
≥rm
;

78 
N§eq_˛o£
 *
ªq
;

80 
ªq
 = (
N§eq_˛o£
*)
nsùcbuf
;

81 
ªq
->
ªq_s
 = 
s
;

82  
	`nsùc
(
NSREQ_CLOSE
, 
ªq
, 0, &
≥rm
);

83 
	}
}

86 
	$nsùc_c⁄√˘
(
s
, c⁄° 
sockaddr
 *
«me
, 
sockÀn_t
 
«mñí
)

88 
≥rm
;

89 
N§eq_c⁄√˘
 *
ªq
;

91 
ªq
 = (
N§eq_c⁄√˘
*)
nsùcbuf
;

92 
ªq
->
ªq_s
 = 
s
;

93 
	`memmove
(&
ªq
->
ªq_«me
, 
«me
, 
«mñí
);

94 
ªq
->
ªq_«mñí
 = 
«mñí
;

95  
	`nsùc
(
NSREQ_CONNECT
, 
ªq
, 0, &
≥rm
);

96 
	}
}

99 
	$nsùc_li°í
(
s
, 
backlog
)

101 
≥rm
;

102 
N§eq_li°í
 *
ªq
;

104 
ªq
 = (
N§eq_li°í
*)
nsùcbuf
;

105 
ªq
->
ªq_s
 = 
s
;

106 
ªq
->
ªq_backlog
 = 
backlog
;

107  
	`nsùc
(
NSREQ_LISTEN
, 
ªq
, 0, &
≥rm
);

108 
	}
}

111 
	$nsùc_ªcv
(
s
, *
mem
, 
Àn
, 
Êags
)

113 
≥rm
, 
r
;

114 
N§eq_ªcv
 *
ªq
;

115 *
ªt
;

117 
ªq
 = (
N§eq_ªcv
*)
nsùcbuf
;

118 
ªq
->
ªq_s
 = 
s
;

119 
ªq
->
ªq_Àn
 = 
Àn
;

120 
ªq
->
ªq_Êags
 = 
Êags
;

122 
r
 = 
	`nsùc
(
NSREQ_RECV
, 
ªq
, (*)
REQVA
, &
≥rm
);

124 
	`as£π
(
r
 < 1600 &&Ñ <
Àn
);

125 
ªt
 = (*Ë
REQVA
;

126 
	`memmove
(
mem
, 
ªt
, 
r
);

128  
r
;

129 
	}
}

132 
	$nsùc_£nd
(
s
, c⁄° *
d©≠å
, 
size
, 
Êags
)

134 
≥rm
;

135 
N§eq_£nd
 *
ªq
;

137 
ªq
 = (
N§eq_£nd
*)
nsùcbuf
;

138 
ªq
->
ªq_s
 = 
s
;

139 
	`as£π
(
size
 < 1600);

140 
	`memmove
(&
ªq
->
ªq_d©≠å
, 
d©≠å
, 
size
);

141 
ªq
->
ªq_size
 = 
size
;

142 
ªq
->
ªq_Êags
 = 
Êags
;

143  
	`nsùc
(
NSREQ_SEND
, 
ªq
, 0, &
≥rm
);

144 
	}
}

147 
	$nsùc_sockë
(
domaö
, 
ty≥
, 
¥Ÿocﬁ
)

149 
≥rm
;

150 
N§eq_sockë
 *
ªq
;

152 
ªq
 = (
N§eq_sockë
*)
nsùcbuf
;

153 
ªq
->
ªq_domaö
 = 
domaö
;

154 
ªq
->
ªq_ty≥
 = 
ty≥
;

155 
ªq
->
ªq_¥Ÿocﬁ
 = 
¥Ÿocﬁ
;

156  
	`nsùc
(
NSREQ_SOCKET
, 
ªq
, 0, &
≥rm
);

157 
	}
}

	@lib/printfmt.c

5 
	~<öc/ty≥s.h
>

6 
	~<öc/°dio.h
>

7 
	~<öc/°rög.h
>

8 
	~<öc/°d¨g.h
>

9 
	~<öc/îr‹.h
>

21 c⁄° * c⁄° 
	gîr‹_°rög
[
MAXERROR
 + 1] =

23 
NULL
,

36 
¥öäum
((*
putch
)(, *), *
putd©
,

37 
num
, 
ba£
, 
width
, 
∑dc
)

40 i‡(
num
 >
ba£
) {

41 
	`¥öäum
(
putch
, 
putd©
, 
num
 / 
ba£
, ba£, 
width
 - 1, 
∑dc
);

44 --
width
 > 0)

45 
	`putch
(
∑dc
, 
putd©
);

49 
	`putch
("0123456789abcdef"[
num
 % 
ba£
], 
putd©
);

50 
	}
}

54 
	$gëuöt
(
va_li°
 *
≠
, 
lÊag
)

56 i‡(
lÊag
 >= 2)

57  
	`va_¨g
(*
≠
, );

58 i‡(
lÊag
)

59  
	`va_¨g
(*
≠
, );

61  
	`va_¨g
(*
≠
, );

62 
	}
}

66 
	$gëöt
(
va_li°
 *
≠
, 
lÊag
)

68 i‡(
lÊag
 >= 2)

69  
	`va_¨g
(*
≠
, );

70 i‡(
lÊag
)

71  
	`va_¨g
(*
≠
, );

73  
	`va_¨g
(*
≠
, );

74 
	}
}

77 
	$gëo
(
va_li°
 *
≠
, 
lÊag
)

79 if(
lÊag
 >=2)

81  
	`va_¨g
(*
≠
, );

83 if(
lÊag
)

85  
	`va_¨g
(*
≠
, );

87 
	}
}

90 
¥ötfmt
((*
putch
)(, *), *
putd©
, c⁄° *
fmt
, ...);

92 
	`v¥ötfmt
((*
putch
)(, *), *
putd©
, c⁄° *
fmt
, 
va_li°
 
≠
)

94 c⁄° *
p
;

95 
ch
, 
îr
;

96 
num
;

97 
ba£
, 
lÊag
, 
width
, 
¥ecisi⁄
, 
ÆtÊag
;

98 
∑dc
;

101 (
ch
 = *(*Ë
fmt
++) != '%') {

102 i‡(
ch
 == '\0')

104 
	`putch
(
ch
, 
putd©
);

108 
∑dc
 = ' ';

109 
width
 = -1;

110 
¥ecisi⁄
 = -1;

111 
lÊag
 = 0;

112 
ÆtÊag
 = 0;

113 
ªswôch
:

114 
ch
 = *(*Ë
fmt
++) {

118 
∑dc
 = '-';

119 
ªswôch
;

123 
∑dc
 = '0';

124 
ªswôch
;

136 
¥ecisi⁄
 = 0; ; ++
fmt
) {

137 
¥ecisi⁄
 =Öªcisi⁄ * 10 + 
ch
 - '0';

138 
ch
 = *
fmt
;

139 i‡(
ch
 < '0' || ch > '9')

142 
¥o˚ss_¥ecisi⁄
;

145 
¥ecisi⁄
 = 
	`va_¨g
(
≠
, );

146 
¥o˚ss_¥ecisi⁄
;

149 i‡(
width
 < 0)

150 
width
 = 0;

151 
ªswôch
;

154 
ÆtÊag
 = 1;

155 
ªswôch
;

157 
¥o˚ss_¥ecisi⁄
:

158 i‡(
width
 < 0)

159 
width
 = 
¥ecisi⁄
,Örecision = -1;

160 
ªswôch
;

164 
lÊag
++;

165 
ªswôch
;

169 
	`putch
(
	`va_¨g
(
≠
, ), 
putd©
);

174 
îr
 = 
	`va_¨g
(
≠
, );

175 i‡(
îr
 < 0)

176 
îr
 = -err;

177 i‡(
îr
 > 
MAXERROR
 || (
p
 = 
îr‹_°rög
[îr]Ë=
NULL
)

178 
	`¥ötfmt
(
putch
, 
putd©
, "îr‹ %d", 
îr
);

180 
	`¥ötfmt
(
putch
, 
putd©
, "%s", 
p
);

185 i‡((
p
 = 
	`va_¨g
(
≠
, *)Ë=
NULL
)

186 
p
 = "(null)";

187 i‡(
width
 > 0 && 
∑dc
 != '-')

188 
width
 -
	`°∫Àn
(
p
, 
¥ecisi⁄
); width > 0; width--)

189 
	`putch
(
∑dc
, 
putd©
);

190 ; (
ch
 = *
p
++Ë!'\0' && (
¥ecisi⁄
 < 0 || --¥ecisi⁄ >0); 
width
--)

191 i‡(
ÆtÊag
 && (
ch
 < ' ' || ch > '~'))

192 
	`putch
('?', 
putd©
);

194 
	`putch
(
ch
, 
putd©
);

195 ; 
width
 > 0; width--)

196 
	`putch
(' ', 
putd©
);

201 
num
 = 
	`gëöt
(&
≠
, 
lÊag
);

202 i‡((Ë
num
 < 0) {

203 
	`putch
('-', 
putd©
);

204 
num
 = -()Çum;

206 
ba£
 = 10;

207 
numbî
;

211 
num
 = 
	`gëuöt
(&
≠
, 
lÊag
);

212 
ba£
 = 10;

213 
numbî
;

224 
num
 = 
	`gëuöt
(&
≠
, 
lÊag
);

225 
ba£
 = 8;

226 
numbî
;

230 
	`putch
('0', 
putd©
);

231 
	`putch
('x', 
putd©
);

232 
num
 = ()

233 (
uöçå_t
Ë
	`va_¨g
(
≠
, *);

234 
ba£
 = 16;

235 
numbî
;

239 
num
 = 
	`gëuöt
(&
≠
, 
lÊag
);

240 
ba£
 = 16;

241 
numbî
:

242 
	`¥öäum
(
putch
, 
putd©
, 
num
, 
ba£
, 
width
, 
∑dc
);

247 
	`putch
(
ch
, 
putd©
);

252 
	`putch
('%', 
putd©
);

253 
fmt
--; fmt[-1] != '%'; fmt--)

258 
	}
}

260 
¥ötfmt
((*
putch
)(, *), *
putd©
, c⁄° *
fmt
, ...)

262 
va_li°
 
≠
;

264 
	`va_°¨t
(
≠
, 
fmt
);

265 
	`v¥ötfmt
(
putch
, 
putd©
, 
fmt
, 
≠
);

266 
	`va_íd
(
≠
);

267 
	}
}

269 
	s•rötbuf
 {

270 *
	mbuf
;

271 *
	mebuf
;

272 
	m˙t
;

275 
	$•röçutch
(
ch
, 
•rötbuf
 *
b
)

277 
b
->
˙t
++;

278 i‡(
b
->
buf
 < b->
ebuf
)

279 *
b
->
buf
++ = 
ch
;

280 
	}
}

282 
	$v¢¥ötf
(*
buf
, 
n
, c⁄° *
fmt
, 
va_li°
 
≠
)

284 
•rötbuf
 
b
 = {
buf
, buf+
n
-1, 0};

286 i‡(
buf
 =
NULL
 || 
n
 < 1)

287  -
E_INVAL
;

290 
	`v¥ötfmt
((*)
•röçutch
, &
b
, 
fmt
, 
≠
);

293 *
b
.
buf
 = '\0';

295  
b
.
˙t
;

296 
	}
}

299 
	$¢¥ötf
(*
buf
, 
n
, c⁄° *
fmt
, ...)

301 
va_li°
 
≠
;

302 
rc
;

304 
	`va_°¨t
(
≠
, 
fmt
);

305 
rc
 = 
	`v¢¥ötf
(
buf
, 
n
, 
fmt
, 
≠
);

306 
	`va_íd
(
≠
);

308  
rc
;

309 
	}
}

	@lib/readline.c

1 
	~<öc/°dio.h
>

2 
	~<öc/îr‹.h
>

4 
	#BUFLEN
 1024

	)

5 
	gbuf
[
BUFLEN
];

8 
	$ªadlöe
(c⁄° *
¥om±
)

10 
i
, 
c
, 
echoög
;

12 i‡(
¥om±
 !
NULL
)

13 
	`˝rötf
("%s", 
¥om±
);

15 
i
 = 0;

16 
echoög
 = 
	`isc⁄s
(0);

18 
c
 = 
	`gëch¨
();

19 i‡(
c
 < 0) {

20 
	`˝rötf
("ªadÉº‹: %e\n", 
c
);

21  
NULL
;

22 } i‡((
c
 ='\b' || c ='\x7f'Ë&& 
i
 > 0) {

23 i‡(
echoög
)

24 
	`˝utch¨
('\b');

25 
i
--;

26 } i‡(
c
 >' ' && 
i
 < 
BUFLEN
-1) {

27 i‡(
echoög
)

28 
	`˝utch¨
(
c
);

29 
buf
[
i
++] = 
c
;

30 } i‡(
c
 == '\n' || c == '\r') {

31 i‡(
echoög
)

32 
	`˝utch¨
('\n');

33 
buf
[
i
] = 0;

34  
buf
;

37 
	}
}

	@lib/sockets.c

1 
	~<öc/lib.h
>

2 
	~<lwù/sockës.h
>

5 
	$ac˚±
(
s
, 
sockaddr
 *
addr
, 
sockÀn_t
 *
addæí
)

7  
	`nsùc_ac˚±
(
s
, 
addr
, 
addæí
);

8 
	}
}

11 
	$böd
(
s
, 
sockaddr
 *
«me
, 
sockÀn_t
 
«mñí
)

13  
	`nsùc_böd
(
s
, 
«me
, 
«mñí
);

14 
	}
}

17 
	$shutdown
(
s
, 
how
)

19  
	`nsùc_shutdown
(
s
, 
how
);

20 
	}
}

23 
	$˛o£sockë
(
s
)

25  
	`nsùc_˛o£
(
s
);

26 
	}
}

29 
	$c⁄√˘
(
s
, c⁄° 
sockaddr
 *
«me
, 
sockÀn_t
 
«mñí
)

31  
	`nsùc_c⁄√˘
(
s
, 
«me
, 
«mñí
);

32 
	}
}

35 
	$li°í
(
s
, 
backlog
)

37  
	`nsùc_li°í
(
s
, 
backlog
);

38 
	}
}

41 
	$ªcv
(
s
, *
mem
, 
Àn
, 
Êags
)

43  
	`nsùc_ªcv
(
s
, 
mem
, 
Àn
, 
Êags
);

44 
	}
}

47 
	$£nd
(
s
, c⁄° *
d©≠å
, 
size
, 
Êags
)

49  
	`nsùc_£nd
(
s
, 
d©≠å
, 
size
, 
Êags
);

50 
	}
}

53 
	$sockë
(
domaö
, 
ty≥
, 
¥Ÿocﬁ
)

55  
	`nsùc_sockë
(
domaö
, 
ty≥
, 
¥Ÿocﬁ
);

56 
	}
}

	@lib/string.c

3 
	~<öc/°rög.h
>

9 
	#ASM
 1

	)

12 
	$°æí
(c⁄° *
s
)

14 
n
;

16 
n
 = 0; *
s
 != '\0'; s++)

17 
n
++;

18  
n
;

19 
	}
}

22 
	$°∫Àn
(c⁄° *
s
, 
size_t
 
size
)

24 
n
;

26 
n
 = 0; 
size
 > 0 && *
s
 != '\0'; s++, size--)

27 
n
++;

28  
n
;

29 
	}
}

32 
	$°r˝y
(*
d°
, c⁄° *
§c
)

34 *
ªt
;

36 
ªt
 = 
d°
;

37 (*
d°
++ = *
§c
++) != '\0')

39  
ªt
;

40 
	}
}

43 
	$°∫˝y
(*
d°
, c⁄° *
§c
, 
size_t
 
size
) {

44 
size_t
 
i
;

45 *
ªt
;

47 
ªt
 = 
d°
;

48 
i
 = 0; i < 
size
; i++) {

49 *
d°
++ = *
§c
;

51 i‡(*
§c
 != '\0')

52 
§c
++;

54  
ªt
;

55 
	}
}

57 
size_t


58 
	$°æ˝y
(*
d°
, c⁄° *
§c
, 
size_t
 
size
)

60 *
d°_ö
;

62 
d°_ö
 = 
d°
;

63 i‡(
size
 > 0) {

64 --
size
 > 0 && *
§c
 != '\0')

65 *
d°
++ = *
§c
++;

66 *
d°
 = '\0';

68  
d°
 - 
d°_ö
;

69 
	}
}

72 
	$°rcmp
(c⁄° *
p
, c⁄° *
q
)

74 *
p
 && *∞=*
q
)

75 
p
++, 
q
++;

76  (Ë((Ë*
p
 - (Ë*
q
);

77 
	}
}

80 
	$°∫cmp
(c⁄° *
p
, c⁄° *
q
, 
size_t
 
n
)

82 
n
 > 0 && *
p
 && *∞=*
q
)

83 
n
--, 
p
++, 
q
++;

84 i‡(
n
 == 0)

87  (Ë((Ë*
p
 - (Ë*
q
);

88 
	}
}

93 
	$°rchr
(c⁄° *
s
, 
c
)

95 ; *
s
; s++)

96 i‡(*
s
 =
c
)

97  (*Ë
s
;

99 
	}
}

104 
	$°rföd
(c⁄° *
s
, 
c
)

106 ; *
s
; s++)

107 i‡(*
s
 =
c
)

109  (*Ë
s
;

110 
	}
}

112 #i‡
ASM


114 
	$mem£t
(*
v
, 
c
, 
size_t
 
n
)

116 *
p
;

118 i‡(
n
 == 0)

119  
v
;

120 i‡(()
v
%4 =0 && 
n
%4 == 0) {

121 
c
 &= 0xFF;

122 
c
 = (c<<24)|(c<<16)|(c<<8)|c;

123 
asm
 volatile("cld;Ñep stosl\n"

124 :: "D" (
v
), "a" (
c
), "c" (
n
/4)

127 
asm
 volatile("cld;Ñep stosb\n"

128 :: "D" (
v
), "a" (
c
), "c" (
n
)

130  
v
;

131 
	}
}

134 
	$memmove
(*
d°
, c⁄° *
§c
, 
size_t
 
n
)

136 c⁄° *
s
;

137 *
d
;

139 
s
 = 
§c
;

140 
d
 = 
d°
;

141 i‡(
s
 < 
d
 && s + 
n
 > d) {

142 
s
 +
n
;

143 
d
 +
n
;

144 i‡(()
s
%4 =0 && ()
d
%4 =0 && 
n
%4 == 0)

145 
asm
 volatile("std;Ñep movsl\n"

146 :: "D" (
d
-4), "S" (
s
-4), "c" (
n
/4) : "cc", "memory");

148 
asm
 volatile("std;Ñep movsb\n"

149 :: "D" (
d
-1), "S" (
s
-1), "c" (
n
) : "cc", "memory");

151 
asm
 volatile("cld" ::: "cc");

153 i‡(()
s
%4 =0 && ()
d
%4 =0 && 
n
%4 == 0)

154 
asm
 volatile("cld;Ñep movsl\n"

155 :: "D" (
d
), "S" (
s
), "c" (
n
/4) : "cc", "memory");

157 
asm
 volatile("cld;Ñep movsb\n"

158 :: "D" (
d
), "S" (
s
), "c" (
n
) : "cc", "memory");

160  
d°
;

161 
	}
}

166 
	$mem£t
(*
v
, 
c
, 
size_t
 
n
)

168 *
p
;

169 
m
;

171 
p
 = 
v
;

172 
m
 = 
n
;

173 --
m
 >= 0)

174 *
p
++ = 
c
;

176  
v
;

177 
	}
}

182 
	$memmove
(*
d°
, c⁄° *
§c
, 
size_t
 
n
)

184 c⁄° *
s
;

185 *
d
;

187 
s
 = 
§c
;

188 
d
 = 
d°
;

189 i‡(
s
 < 
d
 && s + 
n
 > d) {

190 
s
 +
n
;

191 
d
 +
n
;

192 
n
-- > 0)

193 *--
d
 = *--
s
;

195 
n
-- > 0)

196 *
d
++ = *
s
++;

198  
d°
;

199 
	}
}

205 
	$mem˝y
(*
d°
, *
§c
, 
size_t
 
n
)

207  
	`memmove
(
d°
, 
§c
, 
n
);

208 
	}
}

211 
	$memcmp
(c⁄° *
v1
, c⁄° *
v2
, 
size_t
 
n
)

213 c⁄° 
uöt8_t
 *
s1
 = (c⁄° uöt8_à*Ë
v1
;

214 c⁄° 
uöt8_t
 *
s2
 = (c⁄° uöt8_à*Ë
v2
;

216 
n
-- > 0) {

217 i‡(*
s1
 !*
s2
)

218  (Ë*
s1
 - (Ë*
s2
;

219 
s1
++, 
s2
++;

223 
	}
}

226 
	$memföd
(c⁄° *
s
, 
c
, 
size_t
 
n
)

228 c⁄° *
íds
 = (c⁄° *Ë
s
 + 
n
;

229 ; 
s
 < 
íds
; s++)

230 i‡(*(c⁄° *Ë
s
 =(Ë
c
)

232  (*Ë
s
;

233 
	}
}

236 
	$°πﬁ
(c⁄° *
s
, **
íd±r
, 
ba£
)

238 
√g
 = 0;

239 
vÆ
 = 0;

242 *
s
 == ' ' || *s == '\t')

243 
s
++;

246 i‡(*
s
 == '+')

247 
s
++;

248 i‡(*
s
 == '-')

249 
s
++, 
√g
 = 1;

252 i‡((
ba£
 =0 || ba£ =16Ë&& (
s
[0] == '0' && s[1] == 'x'))

253 
s
 +2, 
ba£
 = 16;

254 i‡(
ba£
 =0 && 
s
[0] == '0')

255 
s
++, 
ba£
 = 8;

256 i‡(
ba£
 == 0)

257 
ba£
 = 10;

261 
dig
;

263 i‡(*
s
 >= '0' && *s <= '9')

264 
dig
 = *
s
 - '0';

265 i‡(*
s
 >= 'a' && *s <= 'z')

266 
dig
 = *
s
 - 'a' + 10;

267 i‡(*
s
 >= 'A' && *s <= 'Z')

268 
dig
 = *
s
 - 'A' + 10;

271 i‡(
dig
 >
ba£
)

273 
s
++, 
vÆ
 = (vÆ * 
ba£
Ë+ 
dig
;

277 i‡(
íd±r
)

278 *
íd±r
 = (*Ë
s
;

279  (
√g
 ? -
vÆ
 : val);

280 
	}
}

	@
1
.
0
32
417
boot/main.c
inc/assert.h
inc/elf.h
inc/error.h
inc/kbdreg.h
inc/malloc.h
inc/memlayout.h
inc/mmu.h
inc/queue.h
inc/stab.h
inc/stdarg.h
inc/stdio.h
inc/string.h
inc/types.h
inc/x86.h
kern/console.c
kern/console.h
kern/init.c
kern/kclock.c
kern/kclock.h
kern/kdebug.c
kern/kdebug.h
kern/monitor.c
kern/monitor.h
kern/pmap.c
kern/pmap.h
kern/printf.c
lib/nsipc.c
lib/printfmt.c
lib/readline.c
lib/sockets.c
lib/string.c
